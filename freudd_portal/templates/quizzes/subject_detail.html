{% extends "base.html" %}
{% block title %}fag · {{ subject.title|lower }}{% endblock %}
{% block content %}
<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap");

  .subject-layout {
    --subject-font-ui: "Inter", "Public Sans", "Manrope", sans-serif;
    --subject-font-editorial: "Playfair Display", "Fraunces", serif;
    --subject-space-section: clamp(20px, 2vw, 30px);
    --subject-space-block: clamp(14px, 1.4vw, 20px);
    --subject-space-tight: clamp(10px, 0.9vw, 14px);
    display: grid;
    gap: var(--subject-space-section);
    font-family: var(--subject-font-ui);
    min-width: 0;
  }

  .subject-mobile-topbar {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .subject-mobile-brand {
    margin: 0;
  }

  .subject-mobile-logout {
    min-height: 42px;
    border-radius: 14px;
    border: 1px solid color-mix(in srgb, var(--text-subtle-2) 44%, var(--border));
    background: color-mix(in srgb, var(--surface) 94%, var(--surface-soft));
    color: var(--text-subtle-2);
    font-family: var(--subject-font-ui);
    font-size: 1rem;
    font-weight: 600;
    padding: 0 18px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .subject-mobile-topbar form {
    margin: 0;
  }

  .subject-head {
    display: grid;
    gap: var(--subject-space-block);
  }

  .subject-head-copy {
    display: grid;
    gap: var(--subject-space-tight);
  }

  .subject-head h1,
  .subject-head p {
    margin: 0;
  }

  .subject-head h1 {
    font-family: var(--subject-font-editorial);
    font-weight: 700;
    letter-spacing: -0.012em;
    text-transform: lowercase;
  }

  .subject-back {
    justify-self: flex-start;
    transition: filter 160ms ease;
  }

  .subject-back:hover {
    filter: brightness(0.96);
  }

  .subject-path {
    display: grid;
    gap: var(--subject-space-block);
  }

  .subject-path-layout {
    display: grid;
    grid-template-columns: minmax(220px, 300px) minmax(0, 1fr);
    gap: var(--subject-space-block);
    align-items: start;
  }

  .subject-path-layout > * {
    min-width: 0;
  }

  .lecture-rail {
    position: relative;
    padding-top: 8px;
  }

  .lecture-rail-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: var(--subject-space-tight);
  }

  .lecture-rail-item {
    position: relative;
    min-height: 82px;
    display: grid;
    grid-template-columns: 36px minmax(0, 1fr);
    column-gap: var(--space-3);
    align-items: start;
  }

  .lecture-rail-item::after {
    content: "";
    position: absolute;
    top: 36px;
    bottom: calc(-1 * var(--subject-space-tight));
    left: 18px;
    width: 2px;
    background: var(--timeline-connector);
  }

  .lecture-rail-item:last-child::after {
    display: none;
  }

  .lecture-rail-item.is-past::after,
  .lecture-rail-item.is-completed::after {
    background: #be9358;
  }

  .lecture-rail-link {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: var(--surface-soft);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-family: var(--subject-font-ui);
    font-size: 1.22rem;
    font-weight: 500;
    line-height: 1;
    box-shadow: inset 0 0 0 1px rgba(106, 127, 165, 0.15);
    position: relative;
    z-index: 1;
    transition:
      background 160ms ease,
      border-color 160ms ease,
      color 160ms ease,
      box-shadow 160ms ease;
  }

  .lecture-rail-item:not(.is-active):not(.is-past):not(.is-completed) .lecture-rail-link:hover {
    border-color: color-mix(in srgb, var(--accent) 26%, var(--border));
    background: color-mix(in srgb, var(--accent) 12%, var(--surface-soft));
    color: var(--text-subtle-2);
  }

  .lecture-rail-item:not(.is-active):not(.is-past):not(.is-completed):hover .lecture-rail-link {
    border-color: color-mix(in srgb, var(--accent) 26%, var(--border));
    background: color-mix(in srgb, var(--accent) 12%, var(--surface-soft));
    color: var(--text-subtle-2);
  }

  .lecture-rail-item.is-active .lecture-rail-link:hover {
    background: color-mix(in srgb, #be9358 22%, var(--surface));
  }

  .lecture-rail-item:not(.is-active):not(.is-past):not(.is-completed):hover .lecture-rail-copy {
    color: var(--text-subtle-2);
  }

  .lecture-rail-item.is-active .lecture-rail-link {
    border-color: #be9358;
    background: color-mix(in srgb, #be9358 14%, var(--surface));
    color: #2c2316;
    box-shadow: inset 0 0 0 1px color-mix(in srgb, #be9358 28%, transparent);
  }

  .lecture-rail-item.is-past .lecture-rail-link,
  .lecture-rail-item.is-completed .lecture-rail-link {
    background: #be9358;
    border-color: #be9358;
    color: #fff;
    box-shadow: none;
  }

  .lecture-rail-copy {
    margin: 0;
    display: block;
    color: var(--muted);
    font-family: var(--subject-font-ui);
    line-height: 1.34;
    font-size: 0.94rem;
    max-width: none;
    padding-top: 2px;
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
    text-decoration: none;
    transition: color 160ms ease, text-decoration-color 160ms ease;
  }

  .lecture-rail-copy:hover,
  .lecture-rail-copy:focus-visible {
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 0.12em;
    text-decoration-color: currentColor;
  }

  .lecture-rail-item:not(.is-active):not(.is-past):not(.is-completed) .lecture-rail-copy:hover,
  .lecture-rail-item:not(.is-active):not(.is-past):not(.is-completed) .lecture-rail-copy:focus-visible {
    color: var(--text-subtle-2);
  }

  .lecture-rail-copy:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--accent) 30%, transparent);
    outline-offset: 2px;
    border-radius: 4px;
  }

  .lecture-rail-item.is-active .lecture-rail-copy {
    color: var(--text-strong);
    font-weight: 600;
  }

  .lecture-rail-item.is-past .lecture-rail-copy,
  .lecture-rail-item.is-completed .lecture-rail-copy {
    color: #4a5365;
    font-weight: 600;
  }

  .active-lecture-card {
    position: relative;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--surface);
    padding: var(--subject-space-block);
    display: grid;
    gap: var(--subject-space-block);
    box-shadow: var(--shadow-container);
    min-height: 420px;
    min-width: 0;
  }

  .active-lecture-card::before {
    content: "";
    position: absolute;
    left: -14px;
    top: 38px;
    width: 24px;
    height: 24px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    border-top: 1px solid var(--border);
    transform: rotate(-45deg);
    border-top-left-radius: 4px;
  }

  .active-lecture-head {
    display: grid;
    gap: 6px;
  }

  .active-lecture-title {
    margin: 0;
    color: var(--text-strong);
    font-family: var(--subject-font-editorial);
    font-size: clamp(1.38rem, 2.2vw, 2.08rem);
    font-weight: 500;
    line-height: 1.14;
    letter-spacing: -0.01em;
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
  }

  .active-lecture-progress {
    margin: 0;
    color: var(--text-strong);
    font-family: var(--subject-font-ui);
    font-size: 1rem;
    line-height: 1.2;
    font-weight: 700;
  }

  .active-lecture-state {
    margin: 0;
    font-family: var(--subject-font-ui);
    font-size: 0.95rem;
    color: var(--muted);
  }

  .active-lecture-meta {
    display: grid;
    gap: 2px;
  }

  .active-lecture-sections {
    display: grid;
    gap: var(--subject-space-block);
  }

  .lecture-section {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--subject-space-block);
    display: grid;
    gap: var(--subject-space-tight);
    background: color-mix(in srgb, var(--surface) 88%, var(--surface-soft));
  }

  .lecture-section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .section-title-wrap {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .asset-icon {
    width: 24px;
    height: 24px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--text-strong);
    flex-shrink: 0;
  }

  .asset-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 1.9;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .asset-icon.is-podcast {
    color: var(--text-strong);
  }

  .asset-icon.is-reading {
    color: var(--text-strong);
  }

  .section-title {
    margin: 0;
    font-family: var(--subject-font-editorial);
    font-size: clamp(1.34rem, 1.8vw, 1.52rem);
    font-weight: 700;
    color: var(--text-strong);
    line-height: 1.12;
    letter-spacing: -0.006em;
  }

  .section-note {
    margin: 0;
    color: var(--muted);
    font-family: var(--subject-font-ui);
    font-size: 0.88rem;
  }

  .quiz-band {
    border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
    border-radius: var(--radius-sub);
    overflow: hidden;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .quiz-slot {
    min-height: 114px;
    padding: var(--space-3);
    display: grid;
    justify-items: center;
    align-content: center;
    gap: var(--space-2);
    text-align: center;
    border-right: 1px solid color-mix(in srgb, var(--border) 66%, transparent);
    transition: background 160ms ease;
  }

  .quiz-slot:last-child {
    border-right: 0;
  }

  .quiz-slot.is-easy {
    background: #d8efd7;
  }

  .quiz-slot.is-medium {
    background: #f6e5c8;
  }

  .quiz-slot.is-hard {
    background: #f5d8df;
  }

  .quiz-slot.has-action:hover {
    filter: brightness(0.95);
  }

  .quiz-slot.has-action:hover .quiz-slot-label {
    color: color-mix(in srgb, var(--text-strong) 88%, #000);
  }

  .quiz-slot.has-action:hover .quiz-slot-chip {
    background: color-mix(in srgb, var(--surface-strong) 74%, var(--surface-soft));
    color: color-mix(in srgb, var(--text-strong) 88%, #000);
  }

  .quiz-slot-label {
    margin: 0;
    color: var(--text-strong);
    font-family: var(--subject-font-ui);
    font-size: 0.96rem;
    font-weight: 600;
  }

  .quiz-slot-chip {
    width: 46px;
    height: 46px;
    border-radius: var(--radius-pill);
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-family: var(--subject-font-ui);
    font-size: 1.04rem;
    font-weight: 600;
    text-decoration: none;
    color: var(--text-strong);
    background: color-mix(in srgb, var(--surface) 72%, transparent);
    transition:
      background 160ms ease,
      color 160ms ease,
      transform 160ms ease;
  }

  .quiz-slot-chip:not(.is-disabled):hover {
    background: color-mix(in srgb, var(--surface-strong) 74%, var(--surface-soft));
    color: color-mix(in srgb, var(--text-strong) 88%, #000);
    transform: translateY(-1px);
  }

  .quiz-slot.is-easy .quiz-slot-chip {
    border-color: rgba(31, 143, 78, 0.5);
  }

  .quiz-slot.is-medium .quiz-slot-chip {
    border-color: rgba(164, 122, 33, 0.5);
  }

  .quiz-slot.is-hard .quiz-slot-chip {
    border-color: rgba(178, 59, 79, 0.5);
  }

  .quiz-slot-chip.is-disabled {
    opacity: 0.44;
  }

  .podcast-list {
    margin: 0;
    padding: 0;
    list-style: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-sub);
    background: var(--surface);
  }

  .podcast-row {
    display: grid;
    gap: var(--space-2);
    align-items: start;
    padding: var(--space-3);
    border-bottom: 1px solid var(--border);
    position: relative;
  }

  .podcast-row:last-child {
    border-bottom: 0;
  }

  .podcast-row.has-open-podcast {
    cursor: pointer;
    transition: background 160ms ease;
  }

  .podcast-row.has-open-podcast:hover {
    background: color-mix(in srgb, #1db954 16%, var(--surface));
  }

  .podcast-row.has-open-podcast:hover .podcast-title,
  .podcast-row.has-open-podcast:focus-visible .podcast-title {
    color: color-mix(in srgb, #1db954 82%, #0f4221);
  }

  .podcast-row.has-open-podcast:hover .podcast-meta,
  .podcast-row.has-open-podcast:focus-visible .podcast-meta {
    color: color-mix(in srgb, #1db954 72%, #1b6034);
  }

  .podcast-row.has-open-podcast:focus-visible {
    outline: 2px solid color-mix(in srgb, #1db954 54%, transparent);
    outline-offset: -2px;
    background: color-mix(in srgb, #1db954 16%, var(--surface));
  }

  .podcast-hover-actions {
    position: absolute;
    top: 50%;
    left: 50%;
    z-index: 2;
    display: inline-flex;
    gap: var(--space-2);
    align-items: center;
    pointer-events: none;
  }

  .podcast-hover-actions[hidden] {
    display: none !important;
  }

  .podcast-hover-action {
    border-radius: var(--radius-pill);
    border: 1px solid color-mix(in srgb, #1db954 62%, transparent);
    background: color-mix(in srgb, #1db954 20%, #fff);
    color: color-mix(in srgb, #1db954 90%, #0f4221);
    padding: 0.28rem 0.72rem;
    font-family: var(--subject-font-ui);
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.01em;
    text-transform: lowercase;
    pointer-events: auto;
    cursor: pointer;
    text-decoration: none;
    box-shadow: 0 1px 2px rgba(15, 66, 33, 0.08);
  }

  .podcast-hover-action:hover {
    background: color-mix(in srgb, #1db954 30%, #fff);
    color: color-mix(in srgb, #1db954 96%, #0b311b);
  }

  .podcast-hover-action.is-listen {
    border-color: color-mix(in srgb, #1db954 40%, var(--border));
    background: color-mix(in srgb, #1db954 14%, var(--surface));
  }

  .podcast-row.has-open-podcast .podcast-hover-actions {
    opacity: 0;
    transform: translate(-50%, calc(-50% - 4px));
    transition:
      opacity 160ms ease,
      transform 160ms ease;
  }

  .podcast-row.has-open-podcast:hover .podcast-hover-actions,
  .podcast-row.has-open-podcast:focus-visible .podcast-hover-actions {
    opacity: 1;
    transform: translate(-50%, -50%);
  }

  .podcast-row.has-open-podcast.is-player-open .podcast-hover-actions,
  .podcast-row.has-open-podcast.is-player-open:hover .podcast-hover-actions,
  .podcast-row.has-open-podcast.is-player-open:focus-visible .podcast-hover-actions {
    opacity: 0;
    transform: translate(-50%, calc(-50% - 4px));
    pointer-events: none;
    display: none;
  }

  .podcast-copy {
    min-width: 0;
    display: grid;
    gap: 2px;
  }

  .podcast-title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .podcast-title-main {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    min-width: 0;
    flex: 1 1 auto;
  }

  .podcast-title {
    margin: 0;
    font-family: var(--subject-font-ui);
    font-size: 1.12rem;
    font-weight: 500;
    color: var(--text-strong);
    line-height: 1.28;
    overflow-wrap: anywhere;
    flex: 1 1 auto;
    min-width: 0;
  }

  .podcast-meta {
    margin: 0;
    color: var(--muted);
    font-family: var(--subject-font-ui);
    font-size: 0.88rem;
  }

  .podcast-inline-trigger {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, #1db954 50%, var(--border));
    background: color-mix(in srgb, #1db954 14%, var(--surface));
    color: #1db954;
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition:
      background 160ms ease,
      border-color 160ms ease,
      color 160ms ease,
      transform 160ms ease;
  }

  .podcast-inline-trigger:hover {
    border-color: color-mix(in srgb, #1db954 68%, var(--border));
    background: color-mix(in srgb, #1db954 24%, var(--surface));
    color: color-mix(in srgb, #1db954 82%, #0f4221);
    transform: translateY(-1px);
  }

  .podcast-inline-trigger.is-active {
    border-color: color-mix(in srgb, #1db954 68%, var(--border));
    background: color-mix(in srgb, #1db954 24%, var(--surface));
    color: color-mix(in srgb, #1db954 82%, #0f4221);
  }

  .podcast-inline-trigger svg {
    width: 20px;
    height: 20px;
    display: block;
  }

  .podcast-inline-trigger circle {
    fill: currentColor;
  }

  .podcast-inline-trigger path {
    fill: none;
    stroke: var(--surface);
    stroke-width: 1.9;
    stroke-linecap: round;
    opacity: 0.92;
  }

  .tracking-toggle-form {
    margin: 0;
    flex-shrink: 0;
  }

  .tracking-toggle-button {
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 1px solid var(--border-strong);
    background: var(--surface);
    color: var(--text-subtle-2);
    padding: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition:
      transform 150ms ease,
      border-color 150ms ease,
      background 150ms ease,
      color 150ms ease,
      box-shadow 150ms ease;
  }

  .tracking-toggle-button svg {
    width: 17px;
    height: 17px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2.2;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: transform 150ms ease;
  }

  .tracking-toggle-button:hover {
    border-color: color-mix(in srgb, var(--accent) 48%, var(--border-strong));
    background: var(--surface-soft);
    color: var(--accent-strong);
  }

  .tracking-toggle-button:hover svg {
    transform: scale(1.08);
  }

  .tracking-toggle-button:active {
    transform: scale(0.94);
  }

  .tracking-toggle-button:active svg {
    animation: tracking-check-pop 220ms ease-out;
  }

  .tracking-toggle-button.is-marked {
    border-color: rgba(31, 143, 78, 0.44);
    background: var(--success-bg);
    color: var(--success-ink);
  }

  @keyframes tracking-check-pop {
    0% {
      transform: scale(0.8);
    }

    65% {
      transform: scale(1.2);
    }

    100% {
      transform: scale(1);
    }
  }

  .podcast-inline-player {
    grid-column: 1 / -1;
    border: 0;
    border-radius: 0;
    background: transparent;
    padding: 0;
    display: grid;
    gap: var(--space-1);
    margin-left: calc(-1 * var(--space-3));
    margin-right: calc(-1 * var(--space-3));
    width: calc(100% + (2 * var(--space-3)));
  }

  .podcast-inline-player[hidden] {
    display: none;
  }

  .podcast-inline-frame {
    display: block;
    width: 100%;
    min-height: 152px;
    border: 0;
    border-radius: 0;
    background: transparent;
  }

  .reading-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: var(--subject-space-tight);
  }

  .reading-card {
    border: 1px solid var(--border);
    border-radius: var(--radius-sub);
    background: var(--surface);
    padding: var(--space-3);
    display: grid;
    gap: var(--space-2);
    position: relative;
    overflow: hidden;
  }

  .reading-card.has-open-reading {
    cursor: pointer;
    transition:
      background 160ms ease,
      border-color 160ms ease,
      box-shadow 160ms ease;
  }

  .reading-card.has-open-reading:hover {
    background: #eaf4ff;
    border-color: color-mix(in srgb, #4f8ddf 40%, var(--border));
  }

  .reading-card.has-open-reading:focus-visible {
    outline: 2px solid rgba(53, 117, 206, 0.5);
    outline-offset: 2px;
    background: #eaf4ff;
  }

  .reading-hover-label {
    position: absolute;
    top: 50%;
    left: 50%;
    z-index: 2;
    pointer-events: none;
    border-radius: var(--radius-pill);
    border: 1px solid color-mix(in srgb, #4f8ddf 56%, transparent);
    background: color-mix(in srgb, #4f8ddf 16%, #fff);
    color: color-mix(in srgb, #2d6ec9 84%, #143c7a);
    padding: 0.24rem 0.62rem;
    font-family: var(--subject-font-ui);
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.01em;
    text-transform: lowercase;
    opacity: 0;
    transform: translate(-50%, calc(-50% - 4px));
    transition:
      opacity 160ms ease,
      transform 160ms ease;
  }

  .reading-card.has-open-reading:hover .reading-hover-label,
  .reading-card.has-open-reading:focus-visible .reading-hover-label {
    opacity: 1;
    transform: translate(-50%, -50%);
  }

  .reading-card.is-active {
    border-color: color-mix(in srgb, var(--accent) 42%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--accent) 70%, transparent);
  }

  .reading-card.is-completed {
    border-color: color-mix(in srgb, var(--success) 38%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--success) 72%, transparent);
    background: var(--success-bg);
  }

  .reading-card.is-missing {
    border-color: color-mix(in srgb, var(--danger) 42%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--danger) 74%, transparent);
    background: var(--danger-bg-soft);
  }

  .reading-top {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto;
    align-items: start;
    gap: var(--space-3);
  }

  .reading-main {
    min-width: 0;
  }

  .reading-side {
    display: grid;
    gap: var(--space-2);
    justify-items: end;
    align-content: start;
  }

  .reading-title {
    margin: 0;
    font-family: var(--subject-font-editorial);
    color: var(--text-strong);
    font-size: 1.24rem;
    line-height: 1.18;
    letter-spacing: -0.006em;
    flex: 1 1 auto;
    min-width: 0;
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
  }

  .reading-title strong {
    font-family: inherit;
    font-weight: 700;
  }

  .reading-title-row {
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    gap: var(--space-2);
  }

  .reading-meta {
    margin: 0;
    color: var(--muted);
    font-family: var(--subject-font-ui);
    font-size: 0.88rem;
  }

  .reading-actions {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .reading-difficulties {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    flex-wrap: nowrap;
    justify-content: flex-end;
  }

  .difficulty-chip {
    min-width: 44px;
    display: grid;
    justify-items: center;
    gap: 4px;
    text-decoration: none;
    color: var(--muted);
    border: 0;
    padding: 0;
    background: transparent;
  }

  .difficulty-chip.is-disabled {
    opacity: 0.56;
  }

  .difficulty-dot {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    font-family: var(--subject-font-ui);
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-strong);
    transition:
      transform 160ms ease,
      filter 160ms ease;
  }

  .difficulty-label {
    margin: 0;
    color: var(--muted);
    font-family: var(--subject-font-ui);
    font-size: 0.78rem;
    line-height: 1;
    transition: color 160ms ease;
  }

  .difficulty-chip[href]:hover .difficulty-dot {
    transform: translateY(-1px);
    filter: brightness(0.93);
  }

  .difficulty-chip[href]:hover .difficulty-label {
    color: var(--text-subtle-2);
  }

  .difficulty-chip.is-easy .difficulty-dot {
    border-color: rgba(31, 143, 78, 0.4);
    background: #d8efd7;
    color: var(--success-ink);
  }

  .difficulty-chip.is-medium .difficulty-dot {
    border-color: rgba(164, 122, 33, 0.35);
    background: #f6e5c8;
    color: var(--warn-ink-soft);
  }

  .difficulty-chip.is-hard .difficulty-dot {
    border-color: rgba(178, 59, 79, 0.35);
    background: #f5d8df;
    color: var(--danger-ink);
  }

  .missing-badge {
    min-height: 28px;
    border-radius: var(--radius-pill);
    border: 1px solid rgba(178, 59, 79, 0.5);
    background: var(--danger-bg-soft);
    color: var(--danger-ink);
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-family: var(--subject-font-ui);
    font-size: 0.74rem;
    font-weight: 600;
  }

  .missing-note {
    margin: 0;
    color: var(--danger-ink);
    font-family: var(--subject-font-ui);
    font-size: 0.82rem;
  }

  .section-empty,
  .empty-path {
    margin: 0;
    border: 1px dashed var(--border-strong);
    border-radius: var(--radius-sub);
    background: var(--surface-alt);
    padding: var(--space-3);
    font-family: var(--subject-font-ui);
    color: var(--muted);
  }

  @media (min-width: 700px) {
    .subject-head {
      grid-template-columns: 1fr auto;
      align-items: start;
    }

    .subject-back {
      justify-self: end;
    }
  }

  @media (max-width: 1180px) {
    body.page-subject-detail .site-header {
      display: none !important;
    }

    body.page-subject-detail .page-shell {
      max-width: 920px;
      margin: 0 auto;
      padding:
        clamp(14px, 2.2vw, 22px)
        clamp(14px, 2.5vw, 28px)
        calc(92px + env(safe-area-inset-bottom));
    }

    body.page-subject-detail::before {
      opacity: 0.16;
    }

    .subject-layout {
      gap: var(--space-4);
    }

    .subject-head {
      gap: 4px;
    }

    .subject-head h1 {
      font-size: clamp(1.96rem, 4.2vw, 2.5rem);
      line-height: 1.07;
      letter-spacing: -0.008em;
    }

    .subject-head .muted {
      font-size: clamp(0.96rem, 1.95vw, 1.2rem);
      line-height: 1.3;
      letter-spacing: -0.004em;
      color: var(--text-subtle-2);
    }

    .subject-back {
      display: none;
    }

    .subject-path-layout {
      grid-template-columns: minmax(62px, 84px) minmax(0, 1fr);
      gap: var(--space-3);
    }

    .lecture-rail {
      padding-top: 10px;
    }

    .lecture-rail-list {
      gap: 0;
    }

    .lecture-rail-item {
      min-height: 76px;
      grid-template-columns: 34px;
      column-gap: 0;
      justify-content: center;
    }

    .lecture-rail-item::after {
      top: 34px;
      left: 16px;
      bottom: 0;
      width: 3px;
      background: #d6dce7;
    }

    .lecture-rail-item.is-past::after,
    .lecture-rail-item.is-completed::after {
      background: #be9358;
    }

    .lecture-rail-item:last-child::after {
      display: block;
      bottom: -40px;
      opacity: 0.8;
    }

    .lecture-rail-copy {
      display: none;
    }

    .lecture-rail-link {
      box-shadow: none;
      border-color: #a8b2c3;
      background: transparent;
      color: #374156;
      font-weight: 600;
    }

    .lecture-rail-item.is-past .lecture-rail-link,
    .lecture-rail-item.is-completed .lecture-rail-link {
      border-color: #be9358;
      background: #be9358;
      color: #fff;
    }

    .lecture-rail-item.is-active .lecture-rail-link {
      border-color: #be9358;
      background: color-mix(in srgb, #be9358 16%, var(--surface));
      color: #2c2316;
    }

    .active-lecture-card {
      min-height: 0;
      border-radius: 32px;
      border-color: #d9dce5;
      background: #f9f9fb;
      padding: clamp(14px, 2.2vw, 24px);
      box-shadow: 0 8px 22px rgba(30, 43, 69, 0.08);
    }

    .active-lecture-card::before {
      left: -10px;
      top: 102px;
      width: 18px;
      height: 18px;
      border-color: #d9dce5;
      background: #f9f9fb;
    }

    .active-lecture-title {
      font-size: clamp(1.52rem, 3.9vw, 2rem);
      line-height: 1.18;
      letter-spacing: -0.008em;
    }

    .active-lecture-meta {
      gap: 10px;
    }

    .active-lecture-progress {
      font-size: 1rem;
      line-height: 1.22;
      letter-spacing: -0.006em;
    }

    .active-lecture-state {
      font-size: 1rem;
      line-height: 1.24;
      font-weight: 500;
      color: #606b80;
    }

    .active-lecture-sections {
      gap: var(--space-4);
    }

    .lecture-readings {
      order: 1;
    }

    .lecture-podcasts {
      order: 2;
    }

    .lecture-quizzes {
      order: 3;
    }

    .lecture-section {
      border-radius: 28px;
      border-color: #e2e5ed;
      background: #fdfdff;
      padding: clamp(14px, 2vw, 22px);
    }

    .section-title {
      font-size: clamp(1.56rem, 3vw, 1.9rem);
      line-height: 1.1;
      letter-spacing: -0.005em;
    }

    .quiz-band {
      border: 0;
      background: transparent;
      gap: var(--space-2);
      overflow: visible;
    }

    .quiz-slot {
      border: 0;
      border-radius: 16px;
      min-height: 118px;
      padding: var(--space-3);
    }

    .quiz-slot-label {
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: 0.9rem;
      font-weight: 650;
    }

    .quiz-slot-chip {
      width: 52px;
      height: 52px;
      border: 0;
      font-size: 1.06rem;
      font-weight: 700;
    }

    .lecture-quizzes .section-note {
      text-align: center;
      color: #8a93a3;
      font-size: 0.92rem;
      font-style: italic;
      line-height: 1.28;
      margin-top: var(--space-2);
    }

    .podcast-list {
      border: 0;
      background: transparent;
      border-radius: 0;
    }

    .podcast-row {
      padding: var(--space-3) 0;
      border-bottom: 1px solid #e3e6ee;
    }

    .podcast-row.has-open-podcast:hover {
      background: transparent;
    }

    .podcast-row.has-open-podcast:hover .podcast-title {
      color: var(--text-strong);
    }

    .lecture-podcasts .tracking-toggle-form {
      display: none;
    }

    .podcast-title {
      font-size: clamp(1.02rem, 2.1vw, 1.26rem);
      font-weight: 680;
      line-height: 1.22;
      letter-spacing: -0.004em;
      color: #20293a;
    }

    .podcast-meta {
      color: #677287;
      font-size: clamp(0.84rem, 1.45vw, 0.96rem);
      line-height: 1.3;
    }

    .podcast-inline-trigger {
      width: 40px;
      height: 40px;
      border-color: #bdc5d4;
      background: #eef1f7;
      color: #9ca5b4;
      transform: none;
    }

    .podcast-inline-trigger:hover,
    .podcast-inline-trigger.is-active {
      border-color: #aeb7c8;
      background: #e8edf7;
      color: #6f7a8f;
    }

    .reading-top {
      grid-template-columns: minmax(0, 1fr);
    }

    .reading-side {
      justify-items: start;
    }

    .reading-actions {
      justify-content: flex-start;
    }

    .reading-difficulties {
      justify-content: flex-start;
      flex-wrap: wrap;
    }
  }

  @media (max-width: 760px) {
    .subject-layout {
      gap: var(--space-3);
    }

    .subject-path {
      gap: var(--space-3);
    }

    .subject-path-layout {
      grid-template-columns: 56px minmax(0, 1fr);
      gap: 10px;
    }

    .lecture-rail-item {
      min-height: 66px;
      grid-template-columns: 30px;
    }

    .lecture-rail-item::after {
      left: 15px;
      top: 30px;
    }

    .lecture-rail-link {
      width: 30px;
      height: 30px;
      font-size: 0.92rem;
      line-height: 1;
    }

    .active-lecture-card {
      border-radius: 24px;
      padding: var(--space-3);
    }

    .active-lecture-card::before {
      top: 84px;
      left: -8px;
      width: 14px;
      height: 14px;
    }

    .active-lecture-title {
      font-size: clamp(1.34rem, 6.1vw, 1.72rem);
      line-height: 1.2;
      letter-spacing: -0.006em;
    }

    .active-lecture-progress {
      font-size: 0.96rem;
      line-height: 1.22;
    }

    .active-lecture-state {
      font-size: 0.92rem;
      line-height: 1.24;
    }

    .section-title {
      font-size: clamp(1.3rem, 5.2vw, 1.56rem);
      line-height: 1.12;
      letter-spacing: -0.004em;
    }

    .quiz-slot {
      min-height: 102px;
      padding: 10px;
    }

    .quiz-slot-label {
      font-size: 0.82rem;
      letter-spacing: 0.018em;
    }

    .quiz-slot-chip {
      width: 44px;
      height: 44px;
      font-size: 0.96rem;
    }

  }

  @media (hover: none), (pointer: coarse) {
    .lecture-rail-link,
    .tracking-toggle-button,
    .podcast-inline-trigger {
      min-width: 44px;
      min-height: 44px;
    }

    .reading-hover-label {
      display: none;
    }

    .podcast-hover-actions {
      display: none;
    }
  }
</style>

<div class="subject-mobile-topbar">
  <a class="brand subject-mobile-brand" href="{% url 'progress' %}">freudd</a>
  {% if request.user.is_authenticated %}
  <form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button class="subject-mobile-logout" type="submit">Log ud</button>
  </form>
  {% else %}
  <a class="subject-mobile-logout" href="{% url 'login' %}">Log ind</a>
  {% endif %}
</div>

<div class="subject-layout">
  <header class="subject-head">
    <div class="subject-head-copy">
      <h1 class="quiz-title">{{ subject.title }}</h1>
      <p class="muted">{{ subject.description }}</p>
    </div>
    <a class="ghost-link subject-back" href="{% url 'progress' %}">Tilbage til mit overblik</a>
  </header>

  <section class="subject-path" data-subject-path>
    {% if lecture_rail_items and active_lecture %}
    <div class="subject-path-layout">
      <aside class="lecture-rail" aria-label="Forelæsningsforløb">
        <ol class="lecture-rail-list">
          {% for rail in lecture_rail_items %}
          <li class="lecture-rail-item {% if rail.is_active %}is-active{% endif %} {% if rail.is_past %}is-past{% endif %} {% if rail.is_completed %}is-completed{% endif %}">
            <a
              class="lecture-rail-link"
              href="{{ rail.lecture_url }}"
              aria-current="{% if rail.is_active %}step{% else %}false{% endif %}"
              aria-label="{{ rail.lecture_display_title|default:rail.lecture_key }}"
            ></a>
            <a
              class="lecture-rail-copy"
              href="{{ rail.lecture_url }}"
              aria-label="{{ rail.lecture_display_title|default:rail.lecture_key }}"
            >
              {{ rail.rail_copy|default:rail.lecture_display_title }}
            </a>
          </li>
          {% endfor %}
        </ol>
      </aside>

      <article class="active-lecture-card" data-active-lecture-key="{{ active_lecture.lecture_key }}">
        <header class="active-lecture-head">
          {% if active_lecture.lecture_display_label and active_lecture.lecture_display_name %}
          <h2 class="active-lecture-title">
            {{ active_lecture.lecture_display_label }}: {{ active_lecture.lecture_display_name }}
          </h2>
          {% else %}
          <h2 class="active-lecture-title">{{ active_lecture.lecture_display_title }}</h2>
          {% endif %}
          <div class="active-lecture-meta">
            <p class="active-lecture-progress">{{ active_lecture.completed_quizzes }} / {{ active_lecture.total_quizzes }}</p>
            <p class="active-lecture-state">
              {% if active_lecture.status == 'completed' %}
              Fuldført
              {% elif active_lecture.progress_percent > 0 %}
              I gang
              {% else %}
              Ikke startet endnu
              {% endif %}
            </p>
          </div>
        </header>

        <div class="active-lecture-sections">
          <section class="lecture-section lecture-readings" id="subject-library">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon is-reading" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M7 3.75h7.5l4.75 4.75v11.75H7z"></path>
                    <path d="M14.5 3.75V8.5h4.75"></path>
                    <path d="M10 12h6"></path>
                    <path d="M10 15h6"></path>
                  </svg>
                </span>
                <h3 class="section-title">Tekster</h3>
              </div>
            </div>

            {% if active_lecture.readings %}
            <ul class="reading-list">
              {% for reading in active_lecture.readings %}
              <li
                class="reading-card {% if reading.open_url %}has-open-reading{% endif %} {% if reading.is_missing %}is-missing{% endif %} {% if reading.status == 'active' %}is-active{% elif reading.status == 'completed' %}is-completed{% endif %}"
                {% if reading.open_url %}
                data-open-url="{{ reading.open_url }}"
                role="link"
                tabindex="0"
                aria-label="åbn tekst: {{ reading.reading_title }}"
                {% endif %}
              >
                {% if reading.open_url %}
                <span class="reading-hover-label" aria-hidden="true">åben tekst</span>
                {% endif %}
                <div class="reading-top">
                  <div class="reading-main">
                    <div class="reading-title-row">
                      <form method="post" action="{{ reading_tracking_url }}" class="tracking-toggle-form">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        <input type="hidden" name="lecture_key" value="{{ active_lecture.lecture_key }}" />
                        <input type="hidden" name="reading_key" value="{{ reading.reading_key }}" />
                        <input type="hidden" name="action" value="{% if reading.is_marked_read %}unmark{% else %}mark{% endif %}" />
                        <button
                          class="tracking-toggle-button {% if reading.is_marked_read %}is-marked{% endif %}"
                          type="submit"
                          aria-label="{% if reading.is_marked_read %}Fjern markering læst{% else %}Markér læst{% endif %}"
                        >
                          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                            <path d="M5 12.5 9.3 17 19 7.4"></path>
                          </svg>
                          <span class="visually-hidden">{% if reading.is_marked_read %}Læst{% else %}Markér læst{% endif %}</span>
                        </button>
                      </form>
                      <p class="reading-title"><strong>{{ reading.reading_title }}</strong></p>
                    </div>
                    <p class="reading-meta">{{ reading.completed_quizzes }} / {{ reading.total_quizzes }}</p>
                    <p class="reading-meta">
                      {% if reading.status == 'completed' %}
                      Fuldført
                      {% elif reading.status == 'no_quiz' %}
                      Ingen quiz
                      {% elif reading.progress_percent > 0 %}
                      I gang
                      {% else %}
                      Ikke startet endnu
                      {% endif %}
                    </p>
                  </div>
                  <div class="reading-side">
                    {% if reading.is_missing %}
                    <div class="reading-actions">
                      <span class="missing-badge">Mangler kilde</span>
                    </div>
                    {% endif %}

                    <div class="reading-difficulties">
                      {% for slot in reading.difficulty_summary %}
                        {% if slot.quiz_url %}
                        <a class="difficulty-chip is-{{ slot.difficulty }}" href="{{ slot.quiz_url }}">
                          <span class="difficulty-dot">{{ slot.chip }}</span>
                          <span class="difficulty-label">{{ slot.label }}</span>
                        </a>
                        {% else %}
                        <span class="difficulty-chip is-{{ slot.difficulty }} is-disabled">
                          <span class="difficulty-dot">{{ slot.chip }}</span>
                          <span class="difficulty-label">{{ slot.label }}</span>
                        </span>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </div>

                {% if reading.is_missing %}
                <p class="missing-note">Denne tekst er markeret som manglende i kildelisten.</p>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="section-empty">Ingen tekster registreret i denne forelæsning.</p>
            {% endif %}
          </section>

          <section class="lecture-section lecture-podcasts" id="subject-podcasts">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon is-podcast" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M5 8.5a10.5 10.5 0 0 1 10.5 10.5"></path>
                    <path d="M5 4.75a14.25 14.25 0 0 1 14.25 14.25"></path>
                    <path d="M6.25 17.75a1.5 1.5 0 1 0 0.01 0z"></path>
                  </svg>
                </span>
                <h3 class="section-title">Podcasts</h3>
              </div>
            </div>

            {% if active_lecture.podcast_rows %}
            <ul class="podcast-list">
              {% for podcast in active_lecture.podcast_rows %}
              <li
                class="podcast-row {% if podcast.spotify_embed_url %}has-open-podcast{% endif %}"
                {% if podcast.spotify_embed_url %}
                data-spotify-embed-url="{{ podcast.spotify_embed_url }}"
                role="link"
                tabindex="0"
                aria-label="åbn på spotify: Ep. {{ podcast.episode_index }}: {{ podcast.display_title }}"
                {% endif %}
              >
                {% if podcast.spotify_embed_url %}
                <div class="podcast-hover-actions">
                  <button class="podcast-hover-action" type="button" data-podcast-action="open">åbn på spotify</button>
                  <button class="podcast-hover-action is-listen" type="button" data-podcast-action="listen">lyt her</button>
                </div>
                {% endif %}
                <div class="podcast-copy">
                  <div class="podcast-title-row">
                    <div class="podcast-title-main">
                      <form method="post" action="{{ podcast_tracking_url }}" class="tracking-toggle-form">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        <input type="hidden" name="lecture_key" value="{{ podcast.lecture_key }}" />
                        {% if podcast.reading_key %}
                        <input type="hidden" name="reading_key" value="{{ podcast.reading_key }}" />
                        {% endif %}
                        <input type="hidden" name="podcast_key" value="{{ podcast.podcast_key }}" />
                        <input type="hidden" name="action" value="{% if podcast.is_marked_listened %}unmark{% else %}mark{% endif %}" />
                        <button
                          class="tracking-toggle-button {% if podcast.is_marked_listened %}is-marked{% endif %}"
                          type="submit"
                          aria-label="{% if podcast.is_marked_listened %}Fjern markering lyttet{% else %}Markér lyttet{% endif %}"
                        >
                          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                            <path d="M5 12.5 9.3 17 19 7.4"></path>
                          </svg>
                          <span class="visually-hidden">{% if podcast.is_marked_listened %}Lyttet{% else %}Markér lyttet{% endif %}</span>
                        </button>
                      </form>
                      <p class="podcast-title">
                        Ep. {{ podcast.episode_index }}: {{ podcast.display_title }}{% if podcast.duration_label %} ({{ podcast.duration_label }}){% endif %}
                      </p>
                    </div>
                    {% if podcast.spotify_embed_url %}
                    <button
                      class="podcast-inline-trigger"
                      type="button"
                      data-spotify-embed-url="{{ podcast.spotify_embed_url }}"
                      data-spotify-title="Ep. {{ podcast.episode_index }}: {{ podcast.display_title }}"
                      aria-pressed="false"
                      aria-label="Afspil episode {{ podcast.episode_index }} i Spotify-afspilleren"
                    >
                      <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M7.8 14.2c2.6-.7 5.6-.3 7.8 1"></path>
                        <path d="M8.6 11.6c2.9-.8 6.1-.4 8.4 1"></path>
                        <path d="M9.2 9.1c3-.8 6.4-.4 8.8 1.1"></path>
                      </svg>
                    </button>
                    {% endif %}
                  </div>
                </div>
                {% if podcast.spotify_embed_url %}
                <div class="podcast-inline-player" data-spotify-player hidden>
                  <iframe
                    class="podcast-inline-frame"
                    data-spotify-player-frame
                    src=""
                    title="Spotify afspiller"
                    loading="lazy"
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                    referrerpolicy="strict-origin-when-cross-origin"
                  ></iframe>
                </div>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="section-empty">Ingen podcasts registreret i denne forelæsning.</p>
            {% endif %}
          </section>

          <section class="lecture-section lecture-quizzes" id="subject-quizzes">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M14.25 4.5h5.25v5.25"></path>
                    <path d="M13.5 10.5 19.5 4.5"></path>
                    <path d="M10.5 6H6A2.25 2.25 0 0 0 3.75 8.25V18A2.25 2.25 0 0 0 6 20.25h9.75A2.25 2.25 0 0 0 18 18v-4.5"></path>
                  </svg>
                </span>
                <h3 class="section-title">Quizzer</h3>
                <span class="visually-hidden">Quiz for alle kilder</span>
              </div>
            </div>

            <div class="quiz-band">
              {% for slot in active_lecture.quiz_difficulty_slots %}
              <div class="quiz-slot is-{{ slot.difficulty }} {% if slot.quiz_url %}has-action{% endif %}">
                <p class="quiz-slot-label">{{ slot.label }}</p>
                {% if slot.quiz_url %}
                <a class="quiz-slot-chip" href="{{ slot.quiz_url }}">{{ slot.chip }}</a>
                {% else %}
                <span class="quiz-slot-chip is-disabled">{{ slot.chip }}</span>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            <p class="section-note">Quizzer baseret på alle ugens kilder</p>
          </section>
        </div>
      </article>
    </div>
    {% else %}
    <p class="empty-path">Ingen læringssti endnu for dette fag.</p>
    {% endif %}
  </section>

  {% if readings_error %}
  <div class="message error">{{ readings_error }}</div>
  {% endif %}
</div>
<script>
  (() => {
    const section = document.querySelector(".lecture-podcasts");
    if (!section) {
      return;
    }
    const playButtons = Array.from(section.querySelectorAll("button[data-spotify-embed-url]"));
    const playerContainers = Array.from(section.querySelectorAll("[data-spotify-player]"));
    if (!playButtons.length || !playerContainers.length) {
      return;
    }

    const setPressedState = (activeButton = null) => {
      playButtons.forEach((button) => {
        const isActive = button === activeButton;
        button.classList.toggle("is-active", isActive);
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
      });
    };

    const closePlayer = (container) => {
      const frame = container.querySelector("[data-spotify-player-frame]");
      if (!frame) {
        return;
      }
      container.setAttribute("hidden", "");
      frame.setAttribute("src", "");
      frame.setAttribute("title", "Spotify afspiller");
      const row = container.closest(".podcast-row");
      if (row) {
        row.classList.remove("is-player-open");
        const hoverActions = row.querySelector(".podcast-hover-actions");
        if (hoverActions instanceof HTMLElement) {
          hoverActions.removeAttribute("hidden");
        }
      }
    };

    const openPlayer = (button) => {
      const embedUrl = String(button.getAttribute("data-spotify-embed-url") || "").trim();
      if (!embedUrl) {
        return;
      }
      const row = button.closest(".podcast-row");
      const playerContainer = row ? row.querySelector("[data-spotify-player]") : null;
      const playerFrame = playerContainer ? playerContainer.querySelector("[data-spotify-player-frame]") : null;
      const hoverActions = row ? row.querySelector(".podcast-hover-actions") : null;
      if (!(playerContainer && playerFrame)) {
        return;
      }

      const isSameUrl = playerFrame.getAttribute("src") === embedUrl;
      const isOpen = !playerContainer.hasAttribute("hidden");
      if (isSameUrl && isOpen) {
        closePlayer(playerContainer);
        setPressedState(null);
        return;
      }
      playerContainers.forEach((container) => closePlayer(container));

      const title = String(button.getAttribute("data-spotify-title") || "Podcast episode").trim();
      playerFrame.setAttribute("src", embedUrl);
      playerFrame.setAttribute("title", `Spotify afspiller: ${title}`);
      playerContainer.removeAttribute("hidden");
      if (row) {
        row.classList.add("is-player-open");
      }
      if (hoverActions instanceof HTMLElement) {
        hoverActions.setAttribute("hidden", "");
      }
      setPressedState(button);
    };

    playButtons.forEach((button) => {
      button.addEventListener("click", () => openPlayer(button));
    });
  })();

  (() => {
    const cards = Array.from(document.querySelectorAll(".reading-card[data-open-url]"));
    if (!cards.length) {
      return;
    }

    const interactiveSelector = "a, button, input, select, textarea, label, form";
    const openReading = (card) => {
      const url = String(card.getAttribute("data-open-url") || "").trim();
      if (!url) {
        return;
      }
      window.open(url, "_blank", "noopener");
    };

    cards.forEach((card) => {
      card.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof Element && target.closest(interactiveSelector)) {
          return;
        }
        openReading(card);
      });

      card.addEventListener("keydown", (event) => {
        if (event.key !== "Enter" && event.key !== " ") {
          return;
        }
        event.preventDefault();
        openReading(card);
      });
    });
  })();

  (() => {
    const rows = Array.from(document.querySelectorAll(".podcast-row[data-spotify-embed-url]"));
    if (!rows.length) {
      return;
    }

    const interactiveSelector = "a, button, input, select, textarea, label, form, iframe, [data-spotify-player]";
    const openPodcast = (row) => {
      const embedUrl = String(row.getAttribute("data-spotify-embed-url") || "").trim();
      const match = embedUrl.match(/^https:\/\/open\.spotify\.com\/embed\/episode\/([A-Za-z0-9]+)(?:\?.*)?$/);
      if (!match) {
        return;
      }
      const url = embedUrl.replace("/embed/episode/", "/episode/").replace(/\?.*$/, "");
      window.open(url, "_blank", "noopener");
    };

    rows.forEach((row) => {
      const openButton = row.querySelector("[data-podcast-action='open']");
      const listenButton = row.querySelector("[data-podcast-action='listen']");

      if (openButton instanceof HTMLButtonElement) {
        openButton.addEventListener("click", (event) => {
          event.preventDefault();
          openPodcast(row);
        });
      }

      if (listenButton instanceof HTMLButtonElement) {
        listenButton.addEventListener("click", (event) => {
          event.preventDefault();
          const trigger = row.querySelector(".podcast-inline-trigger[data-spotify-embed-url]");
          if (trigger instanceof HTMLButtonElement) {
            trigger.click();
            trigger.focus();
          }
        });
      }

      row.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof Element && target.closest(interactiveSelector)) {
          return;
        }
        openPodcast(row);
      });

      row.addEventListener("keydown", (event) => {
        if (event.key !== "Enter" && event.key !== " ") {
          return;
        }
        event.preventDefault();
        openPodcast(row);
      });
    });
  })();
</script>
{% endblock %}
