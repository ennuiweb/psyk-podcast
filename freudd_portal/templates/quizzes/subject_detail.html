{% extends "base.html" %}
{% block title %}Fag · {{ subject.title }}{% endblock %}
{% block content %}
<style>
  .subject-layout {
    display: grid;
    gap: var(--space-5);
  }

  .subject-head {
    display: grid;
    gap: var(--space-3);
  }

  .subject-head h1 {
    margin: 0;
  }

  .subject-head p {
    margin: 0;
  }

  .subject-back {
    justify-self: flex-start;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-2);
  }

  .overview-card {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: #ffffff;
    padding: var(--space-3);
    display: grid;
    gap: var(--space-1);
    min-height: 84px;
  }

  .overview-label {
    margin: 0;
    font-size: 0.74rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    font-weight: 700;
  }

  .overview-value {
    margin: 0;
    font-size: clamp(1.06rem, 4.8vw, 1.34rem);
    font-weight: 800;
    color: #1f376d;
  }

  .overview-meta {
    margin: 0;
    font-size: 0.78rem;
    color: var(--muted);
  }

  .subject-path {
    display: grid;
    gap: var(--space-2);
  }

  .path-toolbar {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    margin-bottom: var(--space-1);
  }

  .toolbar-btn {
    border: 1px solid var(--border-strong);
    border-radius: var(--radius-pill);
    min-height: var(--control-min-height);
    padding: 0 var(--space-3);
    background: #f6f9ff;
    color: #34528a;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: border-color 160ms ease, background 160ms ease, color 160ms ease;
  }

  .toolbar-btn:hover {
    border-color: rgba(47, 103, 232, 0.46);
    background: var(--accent-soft);
    color: #2148a8;
  }

  .toolbar-btn[disabled] {
    opacity: 0.54;
    cursor: not-allowed;
  }

  .timeline-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: var(--space-4);
  }

  .timeline-item {
    position: relative;
    padding-left: 36px;
    animation: timeline-enter 220ms ease-out both;
  }

  .timeline-item::after {
    content: "";
    position: absolute;
    top: 36px;
    bottom: calc(-1 * var(--space-4));
    left: 15px;
    width: 2px;
    background: #d5e0f4;
  }

  .timeline-item.is-completed::after {
    background: #7da0e5;
  }

  .timeline-item:last-child::after {
    display: none;
  }

  .timeline-marker {
    position: absolute;
    left: 0;
    top: var(--space-3);
    width: 32px;
    height: 32px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: #f4f8ff;
    color: #7e92b8;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.72rem;
    font-weight: 800;
  }

  .timeline-item.is-active .timeline-marker {
    background: #dfeaff;
    border-color: rgba(47, 103, 232, 0.54);
    color: #2251bf;
  }

  .timeline-item.is-completed .timeline-marker {
    background: #e6f8ee;
    border-color: rgba(31, 143, 78, 0.4);
    color: #1f8f4e;
  }

  .lecture-details {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: #ffffff;
    overflow: clip;
  }

  .lecture-details[open] {
    border-color: rgba(47, 103, 232, 0.34);
    box-shadow: 0 8px 22px rgba(28, 62, 140, 0.11);
  }

  .lecture-summary {
    list-style: none;
    cursor: pointer;
    padding: var(--space-3);
    background: #f9fbff;
    display: grid;
    gap: var(--space-1);
    min-height: 64px;
    transition: background 160ms ease;
  }

  .lecture-summary:hover {
    background: #f4f8ff;
  }

  .lecture-summary:focus-visible {
    outline: 2px solid rgba(47, 103, 232, 0.42);
    outline-offset: -2px;
  }

  .lecture-summary::-webkit-details-marker {
    display: none;
  }

  .lecture-summary-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-3);
  }

  .lecture-labels {
    display: grid;
    gap: var(--space-1);
    min-width: 0;
  }

  .lecture-module {
    margin: 0;
    font-size: 0.78rem;
    font-weight: 700;
    color: #5f749e;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .lecture-title {
    margin: 0;
    font-weight: 800;
    font-size: clamp(1.03rem, 2.4vw, 1.18rem);
    color: #1d335f;
    line-height: 1.32;
    overflow-wrap: anywhere;
  }

  .lecture-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.8rem;
    font-weight: 700;
  }

  .status-badge {
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: #ffffff;
    min-height: 30px;
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-size: 0.72rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .status-badge.is-completed {
    border-color: rgba(31, 143, 78, 0.45);
    color: #1f8f4e;
    background: #e7f7ef;
  }

  .status-badge.is-no-quiz {
    border-color: rgba(96, 113, 148, 0.46);
    color: #546b95;
    background: #edf2fb;
  }

  .progress-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    color: var(--muted);
    font-size: 0.78rem;
    font-weight: 700;
  }

  .progress-track {
    width: 100%;
    height: 10px;
    border-radius: var(--radius-pill);
    overflow: hidden;
    background: #e7edf9;
    border: 1px solid #d7e0f2;
    appearance: none;
  }

  .progress-track::-webkit-progress-bar {
    background: #e7edf9;
  }

  .progress-track::-webkit-progress-value {
    background: linear-gradient(90deg, #2f67e8, #4f84ef);
  }

  .progress-track::-moz-progress-bar {
    background: linear-gradient(90deg, #2f67e8, #4f84ef);
  }

  .timeline-item.is-completed .progress-track::-webkit-progress-value {
    background: linear-gradient(90deg, #1f8f4e, #39b968);
  }

  .timeline-item.is-completed .progress-track::-moz-progress-bar {
    background: linear-gradient(90deg, #1f8f4e, #39b968);
  }

  .lecture-summary-status {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  .lecture-chevron {
    color: #6f82a9;
    font-size: 0.96rem;
    transition: transform 140ms ease;
  }

  .lecture-details[open] .lecture-chevron {
    transform: rotate(180deg);
  }

  .lecture-panel {
    border-top: 1px solid rgba(145, 162, 194, 0.4);
    padding: var(--space-3);
    display: grid;
    gap: var(--space-2);
    background: #f4f7ff;
  }

  .lecture-assets,
  .lecture-readings {
    border: 0;
    border-radius: var(--radius-sub);
    background: rgba(255, 255, 255, 0.76);
    padding: var(--space-2) var(--space-3);
    display: grid;
    gap: var(--space-2);
  }

  .lecture-assets {
    box-shadow: inset 0 0 0 1px rgba(138, 160, 201, 0.23);
    width: fit-content;
    max-width: 100%;
    justify-self: flex-start;
  }

  .lecture-readings {
    box-shadow: inset 0 0 0 1px rgba(138, 160, 201, 0.2);
  }

  .asset-title {
    margin: 0;
    color: #53678e;
    font-size: 0.76rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .asset-title-row {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .asset-icon {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-pill);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(117, 141, 186, 0.42);
    background: #eff4ff;
    color: #3a5e9e;
    flex-shrink: 0;
  }

  .asset-icon svg {
    width: 12px;
    height: 12px;
    fill: currentColor;
  }

  .asset-icon.is-reading {
    color: #47658f;
    background: #edf3ff;
  }

  .asset-icon.is-quiz {
    color: #265dc9;
    background: #e9f1ff;
  }

  .asset-icon.is-podcast {
    color: #1f8f4e;
    background: #e8f8ef;
    border-color: rgba(31, 143, 78, 0.35);
  }

  .asset-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
  }

  .asset-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 34px;
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    padding: 0 var(--space-2);
    font-size: 0.78rem;
    font-weight: 700;
    color: #264878;
    text-decoration: none;
    background: #ffffff;
    transition: border-color 160ms ease, background 160ms ease, color 160ms ease, transform 160ms ease;
    box-shadow: 0 1px 0 rgba(31, 55, 109, 0.07);
  }

  .asset-link:hover {
    border-color: rgba(47, 103, 232, 0.46);
    background: var(--accent-soft);
    color: #2148a8;
    transform: translateY(-1px);
  }

  .asset-link:focus-visible {
    outline: 2px solid rgba(47, 103, 232, 0.45);
    outline-offset: 2px;
  }

  .asset-link.asset-link--quiz {
    justify-content: flex-start;
    gap: 6px;
    padding-right: var(--space-3);
  }

  .asset-level-icon {
    width: 16px;
    height: 16px;
    border-radius: var(--radius-pill);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.58rem;
    font-weight: 800;
    border: 1px solid transparent;
    flex-shrink: 0;
  }

  .asset-link.is-easy {
    border-color: rgba(31, 143, 78, 0.4);
    color: #1f7f47;
    background: #eefbf2;
  }

  .asset-link.is-easy .asset-level-icon {
    border-color: rgba(31, 143, 78, 0.38);
    background: #dff4e7;
    color: #1f8f4e;
  }

  .asset-link.is-medium {
    border-color: rgba(164, 122, 33, 0.35);
    color: #7f5f18;
    background: #fcf8eb;
  }

  .asset-link.is-medium .asset-level-icon {
    border-color: rgba(164, 122, 33, 0.36);
    background: #f5ecc7;
    color: #8f6d19;
  }

  .asset-link.is-hard {
    border-color: rgba(178, 59, 79, 0.35);
    color: #953e50;
    background: #fff1f4;
  }

  .asset-link.is-hard .asset-level-icon {
    border-color: rgba(178, 59, 79, 0.38);
    background: #f9dce3;
    color: #a04658;
  }

  .asset-link.is-complete {
    border-color: rgba(31, 143, 78, 0.46);
    color: #1f8f4e;
    background: #e7f7ef;
  }

  .asset-link.is-spotify {
    border-color: rgba(31, 143, 78, 0.42);
    color: #1f8f4e;
    background: #eefbf2;
  }

  .reading-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 800;
    color: #223a69;
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .reading-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: var(--space-1);
  }

  .reading-item {
    border: 0;
    border-radius: var(--radius-sm);
    background: #ffffff;
    padding: var(--space-2) var(--space-3);
    display: grid;
    gap: var(--space-1);
    box-shadow: inset 0 0 0 1px rgba(138, 160, 201, 0.26);
  }

  .reading-item.is-active {
    box-shadow: inset 3px 0 0 #4f7ddb, inset 0 0 0 1px rgba(101, 131, 189, 0.34);
    background: #f8faff;
  }

  .reading-item.is-completed {
    box-shadow: inset 3px 0 0 #2ba95f, inset 0 0 0 1px rgba(31, 143, 78, 0.24);
    background: #f2fbf5;
  }

  .reading-item.is-missing {
    box-shadow: inset 3px 0 0 #c16072, inset 0 0 0 1px rgba(178, 59, 79, 0.24);
    background: #fff7f8;
  }

  .reading-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .reading-name {
    margin: 0;
    font-size: 0.96rem;
    line-height: 1.36;
    overflow-wrap: anywhere;
  }

  .reading-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.79rem;
    font-weight: 700;
  }

  .missing-badge {
    border-radius: var(--radius-pill);
    border: 1px solid rgba(178, 59, 79, 0.55);
    color: var(--danger);
    background: #fff4f6;
    min-height: 30px;
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-size: 0.72rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .reading-status-wrap {
    display: flex;
    gap: var(--space-1);
    align-items: center;
    flex-wrap: wrap;
  }

  .progress-empty {
    margin: 0;
    color: #5b7099;
    font-size: 0.78rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .missing-note {
    margin: 0;
    color: #8f3f4d;
    font-size: 0.76rem;
  }

  .empty-path {
    margin: 0;
    border: 1px dashed var(--border-strong);
    border-radius: var(--radius-sub);
    padding: var(--space-3);
    background: #f7faff;
  }

  @keyframes timeline-enter {
    from {
      opacity: 0;
      transform: translateY(7px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (min-width: 700px) {
    .subject-head {
      grid-template-columns: 1fr auto;
      align-items: start;
    }

    .subject-back {
      justify-self: end;
    }

    .overview-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .lecture-summary {
      padding: var(--space-4);
    }

    .lecture-panel {
      padding: var(--space-4);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .timeline-item,
    .lecture-chevron,
    .toolbar-btn,
    .asset-link {
      animation: none !important;
      transition: none !important;
    }
  }
</style>

<div class="card subject-layout">
  <header class="subject-head">
    <div>
      <h1 class="quiz-title">{{ subject.title }}</h1>
      <p class="muted">{{ subject.description }}</p>
    </div>
    <a class="ghost-link subject-back" href="{% url 'progress' %}">Tilbage til min side</a>
  </header>

  {% if subject_path_lectures %}
  <section aria-label="Forløbsoverblik" class="overview-grid">
    <article class="overview-card">
      <p class="overview-label">Samlet fremdrift</p>
      <p class="overview-value">{{ subject_path_overview.completion_percent }}%</p>
      <p class="overview-meta">{{ subject_path_overview.completed_quizzes }} / {{ subject_path_overview.total_quizzes }} quizzer</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">Forelæsninger</p>
      <p class="overview-value">{{ subject_path_overview.completed_lectures }} / {{ subject_path_overview.total_lectures }}</p>
      <p class="overview-meta">Fuldførte forelæsninger</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">Quizzer tilbage</p>
      <p class="overview-value">{{ subject_path_overview.remaining_quizzes }}</p>
      <p class="overview-meta">Af {{ subject_path_overview.total_quizzes }} i alt</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">Readings tilbage</p>
      <p class="overview-value">{{ subject_path_overview.remaining_readings }}</p>
      <p class="overview-meta">Af {{ subject_path_overview.total_readings }} i alt</p>
    </article>
  </section>
  {% endif %}

  <section class="subject-path" data-subject-path data-subject-slug="{{ subject.slug }}">
    {% if subject_path_lectures %}
    <div class="path-toolbar" role="toolbar" aria-label="Læringssti handlinger">
      <button class="toolbar-btn" type="button" data-expand-all>Udvid alle</button>
      <button class="toolbar-btn" type="button" data-collapse-all>Luk alle</button>
    </div>

    <ol class="timeline-list">
      {% for lecture in subject_path_lectures %}
      <li
        class="timeline-item {% if lecture.status == 'completed' %}is-completed{% else %}is-active{% endif %}"
      >
        <span class="timeline-marker" aria-hidden="true">{{ forloop.counter }}</span>
        <details class="lecture-details" data-lecture-key="{{ lecture.lecture_key }}">
          <summary class="lecture-summary">
            <div class="lecture-summary-top">
              <div class="lecture-labels">
                {% if lecture.lecture_display_label and lecture.lecture_display_name %}
                <p class="lecture-module">{{ lecture.lecture_display_label }}</p>
                <p class="lecture-title">{{ lecture.lecture_display_name }}</p>
                {% else %}
                <p class="lecture-title">{{ lecture.lecture_display_title }}</p>
                {% endif %}
              </div>
              <div class="lecture-summary-status">
                {% if lecture.status == 'completed' %}
                <span class="status-badge is-completed">Fuldført</span>
                {% endif %}
                <span class="lecture-chevron" aria-hidden="true">⌄</span>
              </div>
            </div>
            <p class="lecture-meta">{{ lecture.completed_quizzes }} / {{ lecture.total_quizzes }}</p>
            {% if lecture.progress_percent > 0 %}
            <div class="progress-meta">
              <span>Fremdrift</span>
              <span>{{ lecture.progress_percent }}%</span>
            </div>
            <progress class="progress-track" value="{{ lecture.progress_percent }}" max="100" aria-label="Fremdrift {{ lecture.progress_percent }} procent">
              {{ lecture.progress_percent }}%
            </progress>
            {% else %}
            <p class="progress-empty">Ikke startet endnu</p>
            {% endif %}
          </summary>

          <div class="lecture-panel">
            {% if lecture.lecture_assets.quizzes or lecture.lecture_assets.podcasts %}
            <section class="lecture-assets">
              {% if lecture.lecture_assets.quizzes %}
              <div>
                <p class="asset-title asset-title-row">
                  <span class="asset-icon is-quiz" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                      <path d="M12 3a9 9 0 1 0 9 9h-1.6a7.4 7.4 0 1 1-7.4-7.4V3Zm0 4a5 5 0 1 0 5 5h-1.6a3.4 3.4 0 1 1-3.4-3.4V7Zm7.8-4.2-4.2 1.4 1.4 1.4-3.1 3.1 1.1 1.1 3.1-3.1 1.4 1.4 1.3-4.3Z"></path>
                    </svg>
                  </span>
                  Forelæsningsquiz
                </p>
                <div class="asset-links">
                  {% for quiz in lecture.lecture_assets.quizzes %}
                  <a
                    class="asset-link asset-link--quiz {% if quiz.difficulty == 'easy' %}is-easy{% elif quiz.difficulty == 'medium' %}is-medium{% elif quiz.difficulty == 'hard' %}is-hard{% endif %} {% if lecture.status == 'completed' %}is-complete{% endif %}"
                    href="{{ quiz.quiz_url }}"
                  >
                    <span class="asset-level-icon" aria-hidden="true">
                      {% if quiz.difficulty == 'easy' %}L{% elif quiz.difficulty == 'medium' %}M{% elif quiz.difficulty == 'hard' %}S{% else %}?{% endif %}
                    </span>
                    {{ quiz.difficulty_label_da }}
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}

              {% if lecture.lecture_assets.podcasts %}
              <div>
                <p class="asset-title asset-title-row">
                  <span class="asset-icon is-podcast" aria-hidden="true">
                    <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                      <path d="M5 9h2v6H5V9Zm3-3h2v12H8V6Zm6-2h2v16h-2V4Zm3 4h2v8h-2V8Z"></path>
                    </svg>
                  </span>
                  Forelæsningspodcast
                </p>
                <div class="asset-links">
                  {% for podcast in lecture.lecture_assets.podcasts %}
                  <a class="asset-link is-spotify" href="{{ podcast.url }}" target="_blank" rel="noopener">Spotify episode {{ forloop.counter }}</a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </section>
            {% endif %}

            <section class="lecture-readings">
              <h3 class="reading-title">
                <span class="asset-icon is-reading" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M4 5.5a2.5 2.5 0 0 1 2.5-2.5H20v16H6.5A2.5 2.5 0 0 0 4 21V5.5Zm2.5-1A1.5 1.5 0 0 0 5 6v12.2c.44-.23.94-.36 1.5-.36H19V4.5H6.5Z"></path>
                  </svg>
                </span>
                Readings
              </h3>
              {% if lecture.readings %}
              <ul class="reading-list">
                {% for reading in lecture.readings %}
                <li class="reading-item {% if reading.is_missing %}is-missing{% endif %} {% if reading.status == 'active' %}is-active{% elif reading.status == 'completed' %}is-completed{% endif %}">
                  <div class="reading-head">
                    <p class="reading-name"><strong>{{ reading.reading_title }}</strong></p>
                    <div class="reading-status-wrap">
                      {% if reading.is_missing %}
                      <span class="missing-badge">Mangler kilde</span>
                      {% endif %}
                      {% if reading.status == 'completed' %}
                      <span class="status-badge is-completed">Fuldført</span>
                      {% elif reading.status == 'no_quiz' %}
                      <span class="status-badge is-no-quiz">Ingen quiz</span>
                      {% endif %}
                    </div>
                  </div>

                  {% if reading.is_missing %}
                  <p class="missing-note">Denne reading er markeret som manglende i kildelisten.</p>
                  {% endif %}

                  <p class="reading-meta">{{ reading.completed_quizzes }} / {{ reading.total_quizzes }}</p>
                  {% if reading.progress_percent > 0 %}
                  <progress class="progress-track" value="{{ reading.progress_percent }}" max="100" aria-label="Fremdrift {{ reading.progress_percent }} procent">
                    {{ reading.progress_percent }}%
                  </progress>
                  {% else %}
                  <p class="progress-empty">Ikke startet endnu</p>
                  {% endif %}

                  {% if reading.assets.quizzes %}
                  <div>
                    <p class="asset-title asset-title-row">
                      <span class="asset-icon is-quiz" aria-hidden="true">
                        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                          <path d="M12 3a9 9 0 1 0 9 9h-1.6a7.4 7.4 0 1 1-7.4-7.4V3Zm0 4a5 5 0 1 0 5 5h-1.6a3.4 3.4 0 1 1-3.4-3.4V7Zm7.8-4.2-4.2 1.4 1.4 1.4-3.1 3.1 1.1 1.1 3.1-3.1 1.4 1.4 1.3-4.3Z"></path>
                        </svg>
                      </span>
                      Quiz
                    </p>
                    <div class="asset-links">
                      {% for quiz in reading.assets.quizzes %}
                      <a
                        class="asset-link asset-link--quiz {% if quiz.difficulty == 'easy' %}is-easy{% elif quiz.difficulty == 'medium' %}is-medium{% elif quiz.difficulty == 'hard' %}is-hard{% endif %} {% if reading.status == 'completed' %}is-complete{% endif %}"
                        href="{{ quiz.quiz_url }}"
                      >
                        <span class="asset-level-icon" aria-hidden="true">
                          {% if quiz.difficulty == 'easy' %}L{% elif quiz.difficulty == 'medium' %}M{% elif quiz.difficulty == 'hard' %}S{% else %}?{% endif %}
                        </span>
                        {{ quiz.difficulty_label_da }}
                      </a>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}

                  {% if reading.assets.podcasts %}
                  <div>
                    <p class="asset-title asset-title-row">
                      <span class="asset-icon is-podcast" aria-hidden="true">
                        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                          <path d="M5 9h2v6H5V9Zm3-3h2v12H8V6Zm6-2h2v16h-2V4Zm3 4h2v8h-2V8Z"></path>
                        </svg>
                      </span>
                      Podcast
                    </p>
                    <div class="asset-links">
                      {% for podcast in reading.assets.podcasts %}
                      <a class="asset-link is-spotify" href="{{ podcast.url }}" target="_blank" rel="noopener">Spotify episode {{ forloop.counter }}</a>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="muted">Ingen readings registreret i denne forelæsning.</p>
              {% endif %}
            </section>
          </div>
        </details>
      </li>
      {% endfor %}
    </ol>
    {% else %}
    <p class="muted empty-path">Ingen læringssti endnu for dette fag.</p>
    {% endif %}
  </section>

  {% if readings_error %}
  <div class="message error">{{ readings_error }}</div>
  {% endif %}
</div>

<script>
  (() => {
    const container = document.querySelector("[data-subject-path]");
    if (!container) {
      return;
    }

    const detailsItems = Array.from(container.querySelectorAll(".lecture-details[data-lecture-key]"));
    const expandAllButton = container.querySelector("[data-expand-all]");
    const collapseAllButton = container.querySelector("[data-collapse-all]");
    if (!detailsItems.length) {
      if (expandAllButton) {
        expandAllButton.disabled = true;
      }
      if (collapseAllButton) {
        collapseAllButton.disabled = true;
      }
      return;
    }

    const slug = container.dataset.subjectSlug || "subject";
    const storageKey = `freudd.subject.${slug}.openLectures`;

    const saveOpenState = () => {
      const openKeys = detailsItems.filter((item) => item.open).map((item) => item.dataset.lectureKey || "");
      try {
        window.localStorage.setItem(storageKey, JSON.stringify(openKeys));
      } catch (error) {
        // Ignore localStorage write failures and keep default behavior.
      }
    };

    const restoreOpenState = () => {
      let savedKeys = [];
      try {
        const raw = window.localStorage.getItem(storageKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            savedKeys = parsed.filter((value) => typeof value === "string");
          }
        }
      } catch (error) {
        savedKeys = [];
      }
      if (!savedKeys.length) {
        return;
      }
      const keySet = new Set(savedKeys);
      detailsItems.forEach((item) => {
        const lectureKey = item.dataset.lectureKey || "";
        item.open = keySet.has(lectureKey);
      });
    };

    restoreOpenState();

    detailsItems.forEach((item) => {
      item.addEventListener("toggle", saveOpenState);
    });

    if (expandAllButton) {
      expandAllButton.addEventListener("click", () => {
        detailsItems.forEach((item) => {
          item.open = true;
        });
        saveOpenState();
      });
    }

    if (collapseAllButton) {
      collapseAllButton.addEventListener("click", () => {
        detailsItems.forEach((item) => {
          item.open = false;
        });
        saveOpenState();
      });
    }
  })();
</script>
{% endblock %}
