{% extends "base.html" %}
{% block title %}Fag Â· {{ subject.title }}{% endblock %}
{% block content %}
<style>
  .subject-layout {
    display: grid;
    gap: var(--space-4);
  }

  .subject-head {
    display: grid;
    gap: var(--space-3);
  }

  .subject-head h1 {
    margin: 0;
  }

  .subject-head p {
    margin: 0;
  }

  .subject-status-pill {
    display: inline-flex;
    align-items: center;
    min-height: 30px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    padding: 0 var(--space-2);
    font-size: 0.8rem;
    font-weight: 700;
    background: #ffffff;
  }

  .subject-status-pill.is-enrolled {
    border-color: rgba(31, 143, 78, 0.35);
    color: var(--success);
    background: #eefbf2;
  }

  .subject-status-pill.is-not-enrolled {
    color: var(--muted);
  }

  .subject-back {
    justify-self: flex-start;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-2);
  }

  .overview-card {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: #ffffff;
    padding: var(--space-3);
    display: grid;
    gap: var(--space-1);
    min-height: 84px;
  }

  .overview-label {
    margin: 0;
    font-size: 0.74rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--muted);
    font-weight: 700;
  }

  .overview-value {
    margin: 0;
    font-size: clamp(1.06rem, 4.8vw, 1.34rem);
    font-weight: 800;
    color: #1f376d;
  }

  .overview-meta {
    margin: 0;
    font-size: 0.78rem;
    color: var(--muted);
  }

  .next-focus {
    border: 1px solid rgba(47, 103, 232, 0.26);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    background:
      radial-gradient(circle at 78% 0%, rgba(255, 255, 255, 0.24), transparent 43%),
      linear-gradient(145deg, #2f67e8, #4e83f0);
    color: #ffffff;
  }

  .next-focus-kicker {
    margin: 0;
    font-size: 0.76rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    opacity: 0.9;
    font-weight: 700;
  }

  .next-focus-title {
    margin: var(--space-2) 0 0;
    font-size: clamp(1.04rem, 4.9vw, 1.4rem);
    line-height: 1.2;
  }

  .next-focus-meta,
  .next-focus-step {
    margin: var(--space-2) 0 0;
    font-size: 0.86rem;
    opacity: 0.94;
  }

  .next-focus-actions {
    margin-top: var(--space-3);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .next-focus-cta {
    background: #ffffff;
    color: #204db9;
  }

  .next-focus-cta:hover {
    background: #f5f8ff;
    color: #1f46a6;
  }

  .next-focus-spotify {
    border-color: rgba(255, 255, 255, 0.55);
    color: #ffffff;
    background: rgba(255, 255, 255, 0.1);
  }

  .next-focus-spotify:hover {
    border-color: rgba(255, 255, 255, 0.86);
    color: #ffffff;
    background: rgba(255, 255, 255, 0.22);
  }

  .subject-path {
    display: grid;
    gap: var(--space-3);
  }

  .path-topline {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    align-items: baseline;
    justify-content: space-between;
  }

  .path-topline h2 {
    margin: 0;
    font-size: clamp(1.05rem, 4.4vw, 1.28rem);
  }

  .path-step {
    margin: 0;
    color: var(--muted);
    font-size: 0.84rem;
    font-weight: 700;
  }

  .path-toolbar {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .toolbar-btn {
    border: 1px solid var(--border-strong);
    border-radius: var(--radius-pill);
    min-height: var(--control-min-height);
    padding: 0 var(--space-3);
    background: #f6f9ff;
    color: #34528a;
    font-size: 0.8rem;
    font-weight: 700;
    cursor: pointer;
    transition: border-color 160ms ease, background 160ms ease, color 160ms ease;
  }

  .toolbar-btn:hover {
    border-color: rgba(47, 103, 232, 0.46);
    background: var(--accent-soft);
    color: #2148a8;
  }

  .toolbar-btn[disabled] {
    opacity: 0.54;
    cursor: not-allowed;
  }

  .timeline-list {
    list-style: none;
    margin: 0;
    padding: 0;
    position: relative;
    display: grid;
    gap: var(--space-3);
  }

  .timeline-list::before {
    content: "";
    position: absolute;
    top: var(--space-3);
    bottom: var(--space-3);
    left: 15px;
    width: 2px;
    background: linear-gradient(180deg, #b7c8ea, #d6e1f5);
  }

  .timeline-item {
    position: relative;
    padding-left: 36px;
    animation: timeline-enter 220ms ease-out both;
  }

  .timeline-marker {
    position: absolute;
    left: 0;
    top: var(--space-3);
    width: 30px;
    height: 30px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: #f4f8ff;
    color: #7e92b8;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 800;
  }

  .timeline-item.is-active .timeline-marker {
    background: #dfeaff;
    border-color: rgba(47, 103, 232, 0.54);
    color: #2251bf;
  }

  .timeline-item.is-completed .timeline-marker {
    background: #e6f8ee;
    border-color: rgba(31, 143, 78, 0.4);
    color: #1f8f4e;
  }

  .timeline-item.is-locked .timeline-marker {
    background: #f4f6fb;
    border-color: #d0dceb;
    color: #93a3bf;
  }

  .lecture-details {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: #ffffff;
    overflow: clip;
  }

  .lecture-details[open] {
    border-color: rgba(47, 103, 232, 0.45);
    box-shadow: 0 0 0 3px var(--focus-ring);
  }

  .lecture-summary {
    list-style: none;
    cursor: pointer;
    padding: var(--space-3);
    background: #f9fbff;
    display: grid;
    gap: var(--space-2);
    min-height: 64px;
  }

  .lecture-summary::-webkit-details-marker {
    display: none;
  }

  .lecture-summary-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .lecture-labels {
    display: grid;
    gap: var(--space-1);
  }

  .lecture-title {
    margin: 0;
    font-weight: 800;
    font-size: 0.95rem;
    overflow-wrap: anywhere;
  }

  .lecture-step {
    margin: 0;
    color: var(--muted);
    font-size: 0.77rem;
    font-weight: 700;
  }

  .lecture-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.8rem;
  }

  .status-badge {
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: #ffffff;
    min-height: 30px;
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-size: 0.72rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .status-badge.is-active {
    border-color: rgba(47, 103, 232, 0.5);
    color: #2456c4;
    background: #e8efff;
  }

  .status-badge.is-completed {
    border-color: rgba(31, 143, 78, 0.45);
    color: #1f8f4e;
    background: #e7f7ef;
  }

  .status-badge.is-locked {
    border-color: #cfd9ea;
    color: #7f93b6;
    background: #f4f7fc;
  }

  .status-badge.is-no-quiz {
    border-color: rgba(96, 113, 148, 0.46);
    color: #546b95;
    background: #edf2fb;
  }

  .progress-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    color: var(--muted);
    font-size: 0.78rem;
    font-weight: 700;
  }

  .progress-track {
    width: 100%;
    height: 8px;
    border-radius: var(--radius-pill);
    overflow: hidden;
    background: #e7edf9;
    border: 1px solid #d7e0f2;
    appearance: none;
  }

  .progress-track::-webkit-progress-bar {
    background: #e7edf9;
  }

  .progress-track::-webkit-progress-value {
    background: linear-gradient(90deg, #2f67e8, #4f84ef);
  }

  .progress-track::-moz-progress-bar {
    background: linear-gradient(90deg, #2f67e8, #4f84ef);
  }

  .timeline-item.is-completed .progress-track::-webkit-progress-value {
    background: linear-gradient(90deg, #1f8f4e, #39b968);
  }

  .timeline-item.is-completed .progress-track::-moz-progress-bar {
    background: linear-gradient(90deg, #1f8f4e, #39b968);
  }

  .timeline-item.is-locked .progress-track::-webkit-progress-value {
    background: linear-gradient(90deg, #9aabc8, #a9b8d1);
  }

  .timeline-item.is-locked .progress-track::-moz-progress-bar {
    background: linear-gradient(90deg, #9aabc8, #a9b8d1);
  }

  .lecture-summary-status {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .lecture-chevron {
    color: #6f82a9;
    font-size: 0.96rem;
    transition: transform 140ms ease;
  }

  .lecture-details[open] .lecture-chevron {
    transform: rotate(180deg);
  }

  .lecture-panel {
    border-top: 1px solid var(--border);
    padding: var(--space-3);
    display: grid;
    gap: var(--space-3);
    background: #ffffff;
  }

  .lecture-assets,
  .lecture-readings {
    border: 1px solid var(--border);
    border-radius: var(--radius-sub);
    background: var(--surface-soft);
    padding: var(--space-3);
    display: grid;
    gap: var(--space-2);
  }

  .lecture-readings {
    background: #ffffff;
  }

  .asset-title {
    margin: 0;
    color: var(--muted);
    font-size: 0.76rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .asset-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .asset-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 34px;
    border: 1px solid var(--border);
    border-radius: var(--radius-pill);
    padding: 0 var(--space-2);
    font-size: 0.78rem;
    font-weight: 700;
    color: #315289;
    text-decoration: none;
    background: #ffffff;
    transition: border-color 160ms ease, background 160ms ease, color 160ms ease;
  }

  .asset-link:hover {
    border-color: rgba(47, 103, 232, 0.46);
    background: var(--accent-soft);
    color: #2148a8;
  }

  .asset-link.is-spotify {
    border-color: rgba(31, 143, 78, 0.42);
    color: #1f8f4e;
    background: #eefbf2;
  }

  .reading-title {
    margin: 0;
    font-size: 1.02rem;
  }

  .reading-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: var(--space-2);
  }

  .reading-item {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: #fdfefe;
    padding: var(--space-3);
    display: grid;
    gap: var(--space-2);
  }

  .reading-item.is-active {
    border-color: rgba(47, 103, 232, 0.45);
    background: #f3f7ff;
  }

  .reading-item.is-completed {
    border-color: rgba(31, 143, 78, 0.35);
    background: #eefbf2;
  }

  .reading-item.is-missing {
    border-color: rgba(178, 59, 79, 0.42);
    background: #fff5f7;
  }

  .reading-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .reading-name {
    margin: 0;
    font-size: 0.92rem;
    overflow-wrap: anywhere;
  }

  .reading-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.79rem;
  }

  .missing-badge {
    border-radius: var(--radius-pill);
    border: 1px solid rgba(178, 59, 79, 0.55);
    color: var(--danger);
    background: #fff4f6;
    min-height: 30px;
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-size: 0.72rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .reading-status-wrap {
    display: flex;
    gap: var(--space-1);
    align-items: center;
    flex-wrap: wrap;
  }

  .missing-note {
    margin: 0;
    color: #8f3f4d;
    font-size: 0.76rem;
  }

  .empty-path {
    margin: 0;
    border: 1px dashed var(--border-strong);
    border-radius: var(--radius-sub);
    padding: var(--space-3);
    background: #f7faff;
  }

  @keyframes timeline-enter {
    from {
      opacity: 0;
      transform: translateY(7px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (min-width: 700px) {
    .subject-head {
      grid-template-columns: 1fr auto;
      align-items: start;
    }

    .subject-back {
      justify-self: end;
    }

    .overview-grid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    .lecture-summary {
      padding: var(--space-4);
    }

    .lecture-panel {
      padding: var(--space-4);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .timeline-item,
    .lecture-chevron,
    .toolbar-btn,
    .asset-link {
      animation: none !important;
      transition: none !important;
    }
  }
</style>

<div class="card subject-layout">
  <header class="subject-head">
    <div>
      <h1 class="quiz-title">{{ subject.title }}</h1>
      <p class="muted">{{ subject.description }}</p>
      <span class="subject-status-pill {% if is_enrolled %}is-enrolled{% else %}is-not-enrolled{% endif %}">
        {% if is_enrolled %}Tilmeldt{% else %}Ikke tilmeldt{% endif %}
      </span>
    </div>
    <a class="ghost-link subject-back" href="{% url 'progress' %}">Tilbage til min side</a>
  </header>

  {% if subject_path_lectures %}
  <section aria-label="ForlÃ¸bsoverblik" class="overview-grid">
    <article class="overview-card">
      <p class="overview-label">Samlet fremdrift</p>
      <p class="overview-value">{{ subject_path_overview.completion_percent }}%</p>
      <p class="overview-meta">{{ subject_path_overview.completed_quizzes }} / {{ subject_path_overview.total_quizzes }} quizzer</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">NuvÃ¦rende trin</p>
      <p class="overview-value">
        {% if subject_path_overview.active_lecture_index %}
          {{ subject_path_overview.active_lecture_index }} / {{ subject_path_overview.total_lectures }}
        {% else %}
          {{ subject_path_overview.total_lectures }} / {{ subject_path_overview.total_lectures }}
        {% endif %}
      </p>
      <p class="overview-meta">ForelÃ¦sninger fuldfÃ¸rt: {{ subject_path_overview.completed_lectures }}</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">Quizzer tilbage</p>
      <p class="overview-value">{{ subject_path_overview.remaining_quizzes }}</p>
      <p class="overview-meta">Af {{ subject_path_overview.total_quizzes }} i alt</p>
    </article>
    <article class="overview-card">
      <p class="overview-label">Readings tilbage</p>
      <p class="overview-value">{{ subject_path_overview.remaining_readings }}</p>
      <p class="overview-meta">Af {{ subject_path_overview.total_readings }} i alt</p>
    </article>
  </section>
  {% endif %}

  {% if subject_path_active_lecture %}
  <section class="next-focus" aria-label="NÃ¦ste fokus">
    <p class="next-focus-kicker">NÃ¦ste fokus</p>
    <h2 class="next-focus-title">{{ subject_path_active_lecture.lecture_key }} Â· {{ subject_path_active_lecture.lecture_title }}</h2>
    <p class="next-focus-meta">{{ subject_path_active_lecture.completed_quizzes }} / {{ subject_path_active_lecture.total_quizzes }} quizzer</p>
    {% if subject_path_overview.active_lecture_index and subject_path_overview.total_lectures %}
    <p class="next-focus-step">Trin {{ subject_path_overview.active_lecture_index }} af {{ subject_path_overview.total_lectures }}</p>
    {% endif %}
    <div class="next-focus-actions">
      {% if subject_path_next_focus_url %}
      <a class="btn-primary next-focus-cta" href="{{ subject_path_next_focus_url }}">Start nu</a>
      {% endif %}
      {% if subject_path_next_focus_spotify_url %}
      <a class="ghost-link next-focus-spotify" href="{{ subject_path_next_focus_spotify_url }}" target="_blank" rel="noopener">Spotify episode</a>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <section class="subject-path" data-subject-path data-subject-slug="{{ subject.slug }}">
    <div class="path-topline">
      <h2>LÃ¦ringssti</h2>
      {% if subject_path_overview.total_lectures %}
      <p class="path-step">
        Trin
        {% if subject_path_overview.active_lecture_index %}
          {{ subject_path_overview.active_lecture_index }}
        {% else %}
          {{ subject_path_overview.total_lectures }}
        {% endif %}
        af {{ subject_path_overview.total_lectures }}
      </p>
      {% endif %}
    </div>

    {% if subject_path_lectures %}
    <div class="path-toolbar" role="toolbar" aria-label="LÃ¦ringssti handlinger">
      <button class="toolbar-btn" type="button" data-expand-all>Udvid alle</button>
      <button class="toolbar-btn" type="button" data-collapse-all>Luk alle</button>
    </div>

    <ol class="timeline-list">
      {% for lecture in subject_path_lectures %}
      <li
        class="timeline-item {% if lecture.status == 'completed' %}is-completed{% elif lecture.status == 'active' %}is-active{% else %}is-locked{% endif %}"
      >
        <span class="timeline-marker" aria-hidden="true">{% if lecture.status == 'completed' %}âœ“{% elif lecture.status == 'active' %}â€¢{% else %}ðŸ”’{% endif %}</span>
        <details class="lecture-details" data-lecture-key="{{ lecture.lecture_key }}">
          <summary class="lecture-summary">
            <div class="lecture-summary-top">
              <div class="lecture-labels">
                <p class="lecture-title">{{ lecture.lecture_key }} Â· {{ lecture.lecture_title }}</p>
                <p class="lecture-step">Trin {{ forloop.counter }} af {{ subject_path_overview.total_lectures }}</p>
              </div>
              <div class="lecture-summary-status">
                <span class="status-badge {% if lecture.status == 'active' %}is-active{% elif lecture.status == 'completed' %}is-completed{% else %}is-locked{% endif %}">
                  {% if lecture.status == 'completed' %}FuldfÃ¸rt{% elif lecture.status == 'active' %}Aktiv{% else %}LÃ¥st{% endif %}
                </span>
                <span class="lecture-chevron" aria-hidden="true">âŒ„</span>
              </div>
            </div>
            <p class="lecture-meta">{{ lecture.completed_quizzes }} / {{ lecture.total_quizzes }} quizzer</p>
            <div class="progress-meta">
              <span>Fremdrift</span>
              <span>{{ lecture.progress_percent }}%</span>
            </div>
            <progress class="progress-track" value="{{ lecture.progress_percent }}" max="100" aria-label="Fremdrift {{ lecture.progress_percent }} procent">
              {{ lecture.progress_percent }}%
            </progress>
          </summary>

          <div class="lecture-panel">
            {% if lecture.lecture_assets.quizzes or lecture.lecture_assets.podcasts %}
            <section class="lecture-assets">
              {% if lecture.lecture_assets.quizzes %}
              <div>
                <p class="asset-title">Lecture-quizzer</p>
                <div class="asset-links">
                  {% for quiz in lecture.lecture_assets.quizzes %}
                  <a class="asset-link" href="{{ quiz.quiz_url }}">{{ quiz.difficulty_label_da }}</a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}

              {% if lecture.lecture_assets.podcasts %}
              <div>
                <p class="asset-title">Lecture-podcasts</p>
                <div class="asset-links">
                  {% for podcast in lecture.lecture_assets.podcasts %}
                  <a class="asset-link is-spotify" href="{{ podcast.url }}" target="_blank" rel="noopener">Spotify episode {{ forloop.counter }}</a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </section>
            {% endif %}

            <section class="lecture-readings">
              <h3 class="reading-title">Readings</h3>
              {% if lecture.readings %}
              <ul class="reading-list">
                {% for reading in lecture.readings %}
                <li class="reading-item {% if reading.is_missing %}is-missing{% endif %} {% if reading.status == 'active' %}is-active{% elif reading.status == 'completed' %}is-completed{% endif %}">
                  <div class="reading-head">
                    <p class="reading-name"><strong>{{ reading.reading_title }}</strong></p>
                    <div class="reading-status-wrap">
                      {% if reading.is_missing %}
                      <span class="missing-badge">Mangler kilde</span>
                      {% endif %}
                      <span class="status-badge {% if reading.status == 'active' %}is-active{% elif reading.status == 'completed' %}is-completed{% elif reading.status == 'no_quiz' %}is-no-quiz{% else %}is-locked{% endif %}">
                        {% if reading.status == 'active' %}Aktiv{% elif reading.status == 'completed' %}FuldfÃ¸rt{% elif reading.status == 'no_quiz' %}Ingen quiz{% else %}LÃ¥st{% endif %}
                      </span>
                    </div>
                  </div>

                  {% if reading.is_missing %}
                  <p class="missing-note">Denne reading er markeret som manglende i kildelisten.</p>
                  {% endif %}

                  <p class="reading-meta">{{ reading.completed_quizzes }} / {{ reading.total_quizzes }} quizzer</p>
                  <progress class="progress-track" value="{{ reading.progress_percent }}" max="100" aria-label="Fremdrift {{ reading.progress_percent }} procent">
                    {{ reading.progress_percent }}%
                  </progress>

                  {% if reading.assets.quizzes %}
                  <div>
                    <p class="asset-title">Quizzer</p>
                    <div class="asset-links">
                      {% for quiz in reading.assets.quizzes %}
                      <a class="asset-link" href="{{ quiz.quiz_url }}">{{ quiz.difficulty_label_da }}</a>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}

                  {% if reading.assets.podcasts %}
                  <div>
                    <p class="asset-title">Podcasts</p>
                    <div class="asset-links">
                      {% for podcast in reading.assets.podcasts %}
                      <a class="asset-link is-spotify" href="{{ podcast.url }}" target="_blank" rel="noopener">Spotify episode {{ forloop.counter }}</a>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="muted">Ingen readings registreret i denne forelÃ¦sning.</p>
              {% endif %}
            </section>
          </div>
        </details>
      </li>
      {% endfor %}
    </ol>
    {% else %}
    <p class="muted empty-path">Ingen lÃ¦ringssti endnu for dette fag.</p>
    {% endif %}
  </section>

  {% if readings_error %}
  <div class="message error">{{ readings_error }}</div>
  {% endif %}
</div>

<script>
  (() => {
    const container = document.querySelector("[data-subject-path]");
    if (!container) {
      return;
    }

    const detailsItems = Array.from(container.querySelectorAll(".lecture-details[data-lecture-key]"));
    const expandAllButton = container.querySelector("[data-expand-all]");
    const collapseAllButton = container.querySelector("[data-collapse-all]");
    if (!detailsItems.length) {
      if (expandAllButton) {
        expandAllButton.disabled = true;
      }
      if (collapseAllButton) {
        collapseAllButton.disabled = true;
      }
      return;
    }

    const slug = container.dataset.subjectSlug || "subject";
    const storageKey = `freudd.subject.${slug}.openLectures`;

    const saveOpenState = () => {
      const openKeys = detailsItems.filter((item) => item.open).map((item) => item.dataset.lectureKey || "");
      try {
        window.localStorage.setItem(storageKey, JSON.stringify(openKeys));
      } catch (error) {
        // Ignore localStorage write failures and keep default behavior.
      }
    };

    const restoreOpenState = () => {
      let savedKeys = [];
      try {
        const raw = window.localStorage.getItem(storageKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            savedKeys = parsed.filter((value) => typeof value === "string");
          }
        }
      } catch (error) {
        savedKeys = [];
      }
      if (!savedKeys.length) {
        return;
      }
      const keySet = new Set(savedKeys);
      detailsItems.forEach((item) => {
        const lectureKey = item.dataset.lectureKey || "";
        item.open = keySet.has(lectureKey);
      });
    };

    restoreOpenState();

    detailsItems.forEach((item) => {
      item.addEventListener("toggle", saveOpenState);
    });

    if (expandAllButton) {
      expandAllButton.addEventListener("click", () => {
        detailsItems.forEach((item) => {
          item.open = true;
        });
        saveOpenState();
      });
    }

    if (collapseAllButton) {
      collapseAllButton.addEventListener("click", () => {
        detailsItems.forEach((item) => {
          item.open = false;
        });
        saveOpenState();
      });
    }
  })();
</script>
{% endblock %}
