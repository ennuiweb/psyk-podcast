{% extends "base.html" %}
{% block title %}Quiz · {{ quiz_title }}{% endblock %}
{% block content %}
<style>
  .quiz-login-note-links {
    display: inline-flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .quiz-alert {
    margin-top: 0.9rem;
    border: 1px solid rgba(178, 59, 79, 0.4);
    border-radius: 12px;
    padding: 0.65rem 0.8rem;
    background: #fff3f6;
    color: var(--danger);
  }

  .quiz-loading {
    margin-top: 1rem;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.85rem;
    color: var(--muted);
    background: #f4f8ff;
  }

  .quiz-stage {
    margin-top: 0.95rem;
    border: 1px solid var(--border);
    border-radius: 14px;
    background: #ffffff;
    padding: 0.95rem;
  }

  .quiz-counter {
    margin: 0 0 0.35rem;
  }

  .quiz-question {
    margin: 0 0 0.9rem;
    font-size: clamp(1.08rem, 2.5vw, 1.42rem);
    line-height: 1.36;
  }

  .quiz-options {
    display: grid;
    gap: 0.62rem;
    margin-bottom: 0.9rem;
  }

  .quiz-option {
    text-align: left;
    width: 100%;
    border: 1px solid var(--border-strong);
    border-radius: 12px;
    background: #f8faff;
    color: var(--ink);
    padding: 0.72rem 0.8rem;
    cursor: pointer;
    transition: border-color 140ms ease, background 140ms ease, transform 140ms ease;
  }

  .quiz-option:hover {
    border-color: rgba(47, 103, 232, 0.45);
    background: #edf3ff;
    transform: translateY(-1px);
  }

  .quiz-option.is-selected {
    border-color: rgba(47, 103, 232, 0.62);
    background: #e7efff;
  }

  .quiz-option.is-correct {
    border-color: rgba(31, 143, 78, 0.45);
    background: #e9f9ef;
  }

  .quiz-option.is-wrong {
    border-color: rgba(178, 59, 79, 0.45);
    background: #ffeef2;
  }

  .quiz-hint,
  .quiz-rationale {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.65rem 0.75rem;
    margin: 0 0 0.75rem;
  }

  .quiz-hint {
    color: #2d4d8b;
    background: #eef4ff;
  }

  .quiz-rationale {
    color: #355f8f;
    background: #edf7ff;
  }

  .quiz-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.55rem;
    align-items: center;
    justify-content: space-between;
  }

  .ghost-button {
    border: 1px solid var(--border-strong);
    border-radius: 999px;
    background: #ffffff;
    color: #334c7d;
    padding: 0.56rem 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: border-color 140ms ease, background 140ms ease, color 140ms ease;
  }

  .ghost-button:hover {
    border-color: rgba(47, 103, 232, 0.4);
    background: var(--accent-soft);
    color: #224fbd;
  }

  .ghost-button[disabled] {
    opacity: 0.55;
    cursor: not-allowed;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.6rem;
    margin: 0.9rem 0;
  }

  .summary-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.65rem;
    background: #f7faff;
  }

  .summary-card strong {
    display: block;
    font-size: 1.28rem;
    margin-bottom: 0.1rem;
  }

  .quiz-login-prompt {
    margin-top: 1rem;
    border: 1px solid var(--warn-border);
    border-radius: 14px;
    padding: 0.8rem 0.9rem;
    background: var(--warn-bg);
    color: var(--warn-ink);
  }

  .quiz-login-prompt p {
    margin: 0 0 0.55rem;
  }

  @media (max-width: 640px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
<div class="card quiz-shell">
  <form class="inline-form is-hidden">{% csrf_token %}</form>
  <div class="quiz-head">
    <div>
      <h1 class="quiz-title">{{ quiz_title }}</h1>
      <p class="muted">Sværhedsgrad: {{ quiz_difficulty_label }} · ID: {{ quiz_id }}</p>
    </div>
    {% if user_is_authenticated %}
    <a class="ghost-link" href="{% url 'progress' %}">Tilbage til min side</a>
    {% endif %}
  </div>

  <div id="quiz-error" class="quiz-alert is-hidden"></div>
  <div id="quiz-loading" class="quiz-loading">Indlæser quiz…</div>

  <section id="quiz-question-view" class="quiz-stage is-hidden">
    <p class="muted quiz-counter" id="quiz-counter"></p>
    <h2 class="quiz-question" id="quiz-question"></h2>
    <div id="quiz-hint" class="quiz-hint is-hidden"></div>
    <div id="quiz-options" class="quiz-options"></div>
    <div id="quiz-rationale" class="quiz-rationale is-hidden"></div>
    <div class="quiz-actions">
      <button id="quiz-back" class="ghost-button" type="button">Forrige</button>
      <button id="quiz-hint-btn" class="ghost-button" type="button">Vis hint</button>
      <button id="quiz-next" class="btn-primary" type="button">Næste</button>
    </div>
  </section>

  <section id="quiz-summary-view" class="quiz-stage is-hidden">
    <h2 class="quiz-question">Opsummering</h2>
    <p class="muted" id="quiz-summary-line"></p>
    <div class="summary-grid">
      <div class="summary-card">
        <strong id="summary-correct">0</strong>
        Korrekte svar
      </div>
      <div class="summary-card">
        <strong id="summary-wrong">0</strong>
        Forkerte svar
      </div>
      <div class="summary-card">
        <strong id="summary-skipped">0</strong>
        Ubesvarede
      </div>
      <div class="summary-card">
        <strong id="summary-answered">0 / 0</strong>
        Besvaret
      </div>
    </div>
    <div class="quiz-actions">
      <button id="quiz-review" class="ghost-button" type="button">Gennemgå svar</button>
      <button id="quiz-reset" class="ghost-button" type="button">Tag quiz igen</button>
    </div>
  </section>

  {% if not user_is_authenticated %}
  <div id="login-end-prompt" class="quiz-login-prompt is-hidden">
    <p>Quizzen er færdig. Log ind nu for at gemme din score og se din samlede score.</p>
    <span class="quiz-login-note-links">
      <a class="nav-action" href="{{ login_next_url }}">Log ind</a>
      <a class="nav-action" href="{{ signup_next_url }}">Opret konto</a>
    </span>
  </div>
  {% endif %}
</div>

<script>
  (function () {
    "use strict";

    const quizContentUrl = "{{ quiz_content_url }}";
    const stateApiUrl = "{{ state_api_url }}";
    const isAuthenticated = {{ user_is_authenticated|yesno:"true,false" }};
    const localStateKey = "quiz-local-state:{{ quiz_id }}";
    const loginEndPrompt = document.getElementById("login-end-prompt");

    const loadingNode = document.getElementById("quiz-loading");
    const errorNode = document.getElementById("quiz-error");
    const questionViewNode = document.getElementById("quiz-question-view");
    const summaryViewNode = document.getElementById("quiz-summary-view");

    const counterNode = document.getElementById("quiz-counter");
    const questionNode = document.getElementById("quiz-question");
    const hintNode = document.getElementById("quiz-hint");
    const hintBtnNode = document.getElementById("quiz-hint-btn");
    const optionsNode = document.getElementById("quiz-options");
    const rationaleNode = document.getElementById("quiz-rationale");

    const backBtnNode = document.getElementById("quiz-back");
    const nextBtnNode = document.getElementById("quiz-next");
    const reviewBtnNode = document.getElementById("quiz-review");
    const resetBtnNode = document.getElementById("quiz-reset");

    const summaryLineNode = document.getElementById("quiz-summary-line");
    const summaryCorrectNode = document.getElementById("summary-correct");
    const summaryWrongNode = document.getElementById("summary-wrong");
    const summarySkippedNode = document.getElementById("summary-skipped");
    const summaryAnsweredNode = document.getElementById("summary-answered");

    let quiz = null;
    let state = {
      userAnswers: {},
      currentQuestionIndex: 0,
      hiddenQuestionIndices: [],
      currentView: "question",
      showHintForCurrent: false,
    };

    function getCsrfToken() {
      const cookies = document.cookie ? document.cookie.split(";") : [];
      for (const cookie of cookies) {
        const entry = cookie.trim();
        if (entry.startsWith("csrftoken=")) {
          return decodeURIComponent(entry.slice("csrftoken=".length));
        }
      }
      return "";
    }

    function showError(message) {
      errorNode.textContent = message;
      errorNode.classList.remove("is-hidden");
    }

    function hideError() {
      errorNode.textContent = "";
      errorNode.classList.add("is-hidden");
    }

    function hideLoading() {
      loadingNode.classList.add("is-hidden");
    }

    function parseStoredState(rawValue) {
      if (!rawValue) {
        return null;
      }
      if (typeof rawValue === "object") {
        return rawValue;
      }
      if (typeof rawValue !== "string") {
        return null;
      }
      try {
        return JSON.parse(rawValue);
      } catch (error) {
        return null;
      }
    }

    function loadLocalState() {
      try {
        return parseStoredState(window.localStorage.getItem(localStateKey));
      } catch (error) {
        return null;
      }
    }

    function saveLocalState(payload) {
      try {
        window.localStorage.setItem(localStateKey, JSON.stringify(payload));
      } catch (error) {
        // Local storage can fail in restricted browser modes.
      }
    }

    function clearLocalState() {
      try {
        window.localStorage.removeItem(localStateKey);
      } catch (error) {
        // Ignore local storage failures.
      }
    }

    function normalizeQuizPayload(payload) {
      if (!payload || typeof payload !== "object") {
        return null;
      }
      const questions = Array.isArray(payload.questions) ? payload.questions : [];
      if (!questions.length) {
        return null;
      }
      return {
        title: typeof payload.title === "string" && payload.title.trim() ? payload.title.trim() : "Quiz",
        questions,
      };
    }

    function normalizeStatePayload(rawState) {
      const questionCount = quiz.questions.length;
      const normalized = {
        userAnswers: {},
        currentQuestionIndex: 0,
        hiddenQuestionIndices: [],
        currentView: "question",
        showHintForCurrent: false,
      };

      if (!rawState || typeof rawState !== "object") {
        return normalized;
      }

      if (rawState.userAnswers && typeof rawState.userAnswers === "object") {
        for (const [rawKey, rawValue] of Object.entries(rawState.userAnswers)) {
          const index = Number.parseInt(String(rawKey), 10);
          if (!Number.isInteger(index) || index < 0 || index >= questionCount) {
            continue;
          }
          if (rawValue === null) {
            normalized.userAnswers[String(index)] = null;
            continue;
          }
          if (!Number.isInteger(rawValue)) {
            continue;
          }
          const options = quiz.questions[index]?.answerOptions;
          if (!Array.isArray(options) || rawValue < 0 || rawValue >= options.length) {
            continue;
          }
          normalized.userAnswers[String(index)] = rawValue;
        }
      }

      const indexValue = Number.parseInt(String(rawState.currentQuestionIndex ?? 0), 10);
      if (Number.isInteger(indexValue) && indexValue >= 0 && indexValue < questionCount) {
        normalized.currentQuestionIndex = indexValue;
      }

      if (Array.isArray(rawState.hiddenQuestionIndices)) {
        normalized.hiddenQuestionIndices = rawState.hiddenQuestionIndices
          .map((entry) => Number.parseInt(String(entry), 10))
          .filter((entry) => Number.isInteger(entry) && entry >= 0 && entry < questionCount);
      }

      if (String(rawState.currentView || "").toLowerCase() === "summary") {
        normalized.currentView = "summary";
      }

      return normalized;
    }

    function answeredCount() {
      return Object.values(state.userAnswers).filter((value) => value !== null && value !== undefined).length;
    }

    function summaryStats() {
      let correct = 0;
      let wrong = 0;
      let skipped = 0;
      quiz.questions.forEach((question, index) => {
        const selected = state.userAnswers[String(index)];
        if (selected === null || selected === undefined) {
          skipped += 1;
          return;
        }
        const option = Array.isArray(question.answerOptions) ? question.answerOptions[selected] : null;
        if (option && option.isCorrect === true) {
          correct += 1;
        } else {
          wrong += 1;
        }
      });
      return { correct, wrong, skipped };
    }

    function showEndPromptIfNeeded() {
      if (!loginEndPrompt || isAuthenticated) {
        return;
      }
      if (state.currentView === "summary") {
        loginEndPrompt.classList.remove("is-hidden");
      } else {
        loginEndPrompt.classList.add("is-hidden");
      }
    }

    async function fetchQuiz() {
      const response = await fetch(quizContentUrl, { credentials: "same-origin" });
      if (!response.ok) {
        throw new Error("Kunne ikke hente quiz-indhold.");
      }
      const payload = await response.json();
      const normalized = normalizeQuizPayload(payload);
      if (!normalized) {
        throw new Error("Quiz-indholdet er ugyldigt eller tomt.");
      }
      return normalized;
    }

    async function fetchAccountState() {
      if (!isAuthenticated) {
        return null;
      }
      const response = await fetch(stateApiUrl, { credentials: "same-origin" });
      if (!response.ok) {
        throw new Error("Kunne ikke hente gemt quiz-state.");
      }
      return response.json();
    }

    function currentQuestion() {
      return quiz.questions[state.currentQuestionIndex];
    }

    function renderQuestionView() {
      const question = currentQuestion();
      const options = Array.isArray(question.answerOptions) ? question.answerOptions : [];
      const selectedOption = state.userAnswers[String(state.currentQuestionIndex)];
      const hasAnswered = selectedOption !== null && selectedOption !== undefined;

      counterNode.textContent = `Spørgsmål ${state.currentQuestionIndex + 1} af ${quiz.questions.length}`;
      questionNode.textContent = String(question.question || "");

      optionsNode.innerHTML = "";
      options.forEach((option, optionIndex) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "quiz-option";
        button.textContent = String(option?.text || "");
        if (selectedOption === optionIndex) {
          button.classList.add("is-selected");
          if (option?.isCorrect === true) {
            button.classList.add("is-correct");
          } else {
            button.classList.add("is-wrong");
          }
        } else if (hasAnswered && option?.isCorrect === true) {
          button.classList.add("is-correct");
        }
        button.addEventListener("click", function () {
          state.userAnswers[String(state.currentQuestionIndex)] = optionIndex;
          state.showHintForCurrent = false;
          saveState().catch((error) => {
            showError("Kunne ikke gemme state. Prøv igen.");
          });
          render();
        });
        optionsNode.appendChild(button);
      });

      const hintText = String(question.hint || "").trim();
      if (hintText) {
        hintBtnNode.disabled = false;
        hintBtnNode.textContent = state.showHintForCurrent ? "Skjul hint" : "Vis hint";
        if (state.showHintForCurrent) {
          hintNode.textContent = hintText;
          hintNode.classList.remove("is-hidden");
        } else {
          hintNode.textContent = "";
          hintNode.classList.add("is-hidden");
        }
      } else {
        hintBtnNode.disabled = true;
        hintBtnNode.textContent = "Ingen hint";
        hintNode.textContent = "";
        hintNode.classList.add("is-hidden");
      }

      if (hasAnswered) {
        const selected = options[selectedOption];
        const rationale = String(selected?.rationale || "").trim();
        if (rationale) {
          rationaleNode.textContent = rationale;
          rationaleNode.classList.remove("is-hidden");
        } else {
          rationaleNode.textContent = "";
          rationaleNode.classList.add("is-hidden");
        }
      } else {
        rationaleNode.textContent = "";
        rationaleNode.classList.add("is-hidden");
      }

      backBtnNode.disabled = state.currentQuestionIndex === 0;
      nextBtnNode.textContent =
        state.currentQuestionIndex >= quiz.questions.length - 1 ? "Se opsummering" : "Næste";
    }

    function renderSummaryView() {
      const stats = summaryStats();
      const total = quiz.questions.length;
      summaryLineNode.textContent = `Du svarede ${stats.correct} korrekt ud af ${total}.`;
      summaryCorrectNode.textContent = String(stats.correct);
      summaryWrongNode.textContent = String(stats.wrong);
      summarySkippedNode.textContent = String(stats.skipped);
      summaryAnsweredNode.textContent = `${answeredCount()} / ${total}`;
    }

    function render() {
      hideError();
      hideLoading();

      if (state.currentView === "summary") {
        questionViewNode.classList.add("is-hidden");
        summaryViewNode.classList.remove("is-hidden");
        renderSummaryView();
      } else {
        summaryViewNode.classList.add("is-hidden");
        questionViewNode.classList.remove("is-hidden");
        renderQuestionView();
      }
      showEndPromptIfNeeded();
    }

    async function saveState() {
      const payload = {
        userAnswers: state.userAnswers,
        currentQuestionIndex: state.currentQuestionIndex,
        hiddenQuestionIndices: state.hiddenQuestionIndices,
        currentView: state.currentView,
      };

      saveLocalState(payload);

      if (!isAuthenticated) {
        return;
      }

      const response = await fetch(stateApiUrl, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        throw new Error("Failed to save state");
      }
    }

    async function init() {
      try {
        quiz = await fetchQuiz();
      } catch (error) {
        hideLoading();
        showError("Quizzen kunne ikke indlæses.");
        return;
      }

      const localState = loadLocalState();
      try {
        const accountState = await fetchAccountState();
        state = normalizeStatePayload(accountState || localState);
        render();

        if (isAuthenticated && localState && !accountState) {
          await saveState();
          clearLocalState();
        }
      } catch (error) {
        state = normalizeStatePayload(localState);
        render();
        if (isAuthenticated) {
          showError("Kunne ikke hente kontostate. Viser lokal state i stedet.");
        }
      }
    }

    hintBtnNode.addEventListener("click", function () {
      state.showHintForCurrent = !state.showHintForCurrent;
      render();
    });

    backBtnNode.addEventListener("click", function () {
      if (state.currentView === "summary") {
        state.currentView = "question";
        state.currentQuestionIndex = Math.max(quiz.questions.length - 1, 0);
      } else if (state.currentQuestionIndex > 0) {
        state.currentQuestionIndex -= 1;
      }
      state.showHintForCurrent = false;
      saveState().catch(() => {
        showError("Kunne ikke gemme state. Prøv igen.");
      });
      render();
    });

    nextBtnNode.addEventListener("click", function () {
      if (state.currentQuestionIndex >= quiz.questions.length - 1) {
        state.currentView = "summary";
      } else {
        state.currentQuestionIndex += 1;
      }
      state.showHintForCurrent = false;
      saveState().catch(() => {
        showError("Kunne ikke gemme state. Prøv igen.");
      });
      render();
    });

    reviewBtnNode.addEventListener("click", function () {
      state.currentView = "question";
      state.currentQuestionIndex = 0;
      state.showHintForCurrent = false;
      saveState().catch(() => {
        showError("Kunne ikke gemme state. Prøv igen.");
      });
      render();
    });

    resetBtnNode.addEventListener("click", function () {
      state = normalizeStatePayload(null);
      saveState().catch(() => {
        showError("Kunne ikke nulstille state. Prøv igen.");
      });
      render();
    });

    init();
  })();
</script>
{% endblock %}
