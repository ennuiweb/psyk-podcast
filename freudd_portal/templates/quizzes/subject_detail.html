{% extends "base.html" %}
{% block title %}fag · {{ subject.title|lower }}{% endblock %}
{% block content %}
<style>
  .subject-layout {
    --subject-space-section: clamp(20px, 2vw, 30px);
    --subject-space-block: clamp(14px, 1.4vw, 20px);
    --subject-space-tight: clamp(10px, 0.9vw, 14px);
    display: grid;
    gap: var(--subject-space-section);
  }

  .subject-head {
    display: grid;
    gap: var(--subject-space-block);
  }

  .subject-head-copy {
    display: grid;
    gap: var(--subject-space-tight);
  }

  .subject-head h1,
  .subject-head p {
    margin: 0;
  }

  .subject-back {
    justify-self: flex-start;
  }

  .subject-path {
    display: grid;
    gap: var(--subject-space-block);
  }

  .subject-path-layout {
    display: grid;
    grid-template-columns: 54px minmax(0, 1fr);
    gap: var(--subject-space-block);
    align-items: start;
  }

  .lecture-rail {
    position: relative;
    padding-top: 10px;
  }

  .lecture-rail-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: var(--subject-space-tight);
  }

  .lecture-rail-item {
    position: relative;
    min-height: 62px;
    display: grid;
    justify-items: center;
  }

  .lecture-rail-item::after {
    content: "";
    position: absolute;
    top: 44px;
    bottom: calc(-1 * var(--subject-space-tight));
    left: 50%;
    width: 2px;
    transform: translateX(-50%);
    background: var(--timeline-connector);
  }

  .lecture-rail-item:last-child::after {
    display: none;
  }

  .lecture-rail-item.is-completed::after {
    background: var(--timeline-connector-done);
  }

  .lecture-rail-link {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    background: var(--surface-soft);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 1.22rem;
    font-weight: 500;
    line-height: 1;
    box-shadow: inset 0 0 0 1px rgba(106, 127, 165, 0.15);
  }

  .lecture-rail-item.is-active .lecture-rail-link {
    border-color: color-mix(in srgb, var(--accent) 55%, transparent);
    background: color-mix(in srgb, var(--accent) 36%, var(--surface));
    color: var(--surface);
  }

  .lecture-rail-item.is-completed .lecture-rail-link {
    background: var(--surface-soft);
    border-color: color-mix(in srgb, var(--success) 34%, var(--border));
    color: var(--muted);
  }

  .active-lecture-card {
    position: relative;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--surface);
    padding: var(--subject-space-block);
    display: grid;
    gap: var(--subject-space-block);
    box-shadow: var(--shadow-container);
    min-height: 420px;
  }

  .active-lecture-card::before {
    content: "";
    position: absolute;
    left: -14px;
    top: 38px;
    width: 24px;
    height: 24px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    border-top: 1px solid var(--border);
    transform: rotate(-45deg);
    border-top-left-radius: 4px;
  }

  .active-lecture-head {
    display: grid;
    gap: 6px;
  }

  .active-lecture-title {
    margin: 0;
    color: var(--text-strong);
    font-size: clamp(1.44rem, 2.8vw, 2.4rem);
    line-height: 1.1;
    letter-spacing: -0.02em;
  }

  .active-lecture-progress {
    margin: 0;
    color: var(--text-strong);
    font-size: 1.84rem;
    line-height: 1;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .active-lecture-state {
    margin: 0;
    font-size: 0.98rem;
    color: var(--muted);
  }

  .active-lecture-sections {
    display: grid;
    gap: var(--subject-space-block);
  }

  .lecture-section {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--subject-space-block);
    display: grid;
    gap: var(--subject-space-tight);
    background: color-mix(in srgb, var(--surface) 88%, var(--surface-soft));
  }

  .lecture-section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .section-title-wrap {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .asset-icon {
    width: 28px;
    height: 28px;
    border-radius: var(--radius-pill);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(117, 141, 186, 0.42);
    background: var(--info-bg);
    color: var(--info-ink);
    flex-shrink: 0;
  }

  .asset-icon svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  .asset-icon.is-podcast {
    color: var(--success-ink);
    background: var(--success-bg-strong);
    border-color: rgba(31, 143, 78, 0.35);
  }

  .asset-icon.is-reading {
    color: var(--text-subtle);
    background: var(--surface-soft);
  }

  .section-title {
    margin: 0;
    font-size: clamp(1.24rem, 1.9vw, 1.54rem);
    color: var(--text-strong);
    line-height: 1.1;
    letter-spacing: -0.01em;
  }

  .section-note {
    margin: 0;
    color: var(--muted);
    font-size: 0.95rem;
  }

  .quiz-band {
    border: 1px solid color-mix(in srgb, var(--border) 80%, transparent);
    border-radius: var(--radius-sub);
    overflow: hidden;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .quiz-slot {
    min-height: 114px;
    padding: var(--space-3);
    display: grid;
    justify-items: center;
    align-content: center;
    gap: var(--space-2);
    text-align: center;
    border-right: 1px solid color-mix(in srgb, var(--border) 66%, transparent);
  }

  .quiz-slot:last-child {
    border-right: 0;
  }

  .quiz-slot.is-easy {
    background: #d8efd7;
  }

  .quiz-slot.is-medium {
    background: #f6e5c8;
  }

  .quiz-slot.is-hard {
    background: #f5d8df;
  }

  .quiz-slot-label {
    margin: 0;
    color: var(--text-strong);
    font-size: 1.06rem;
    font-weight: 700;
  }

  .quiz-slot-chip {
    width: 46px;
    height: 46px;
    border-radius: var(--radius-pill);
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.24rem;
    font-weight: 700;
    text-decoration: none;
    color: var(--text-strong);
    background: color-mix(in srgb, var(--surface) 72%, transparent);
  }

  .quiz-slot.is-easy .quiz-slot-chip {
    border-color: rgba(31, 143, 78, 0.5);
  }

  .quiz-slot.is-medium .quiz-slot-chip {
    border-color: rgba(164, 122, 33, 0.5);
  }

  .quiz-slot.is-hard .quiz-slot-chip {
    border-color: rgba(178, 59, 79, 0.5);
  }

  .quiz-slot-chip.is-disabled {
    opacity: 0.44;
  }

  .podcast-list {
    margin: 0;
    padding: 0;
    list-style: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-sub);
    background: var(--surface);
  }

  .podcast-row {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto auto;
    gap: var(--space-2);
    align-items: center;
    padding: var(--space-3);
    border-bottom: 1px solid var(--border);
  }

  .podcast-row:last-child {
    border-bottom: 0;
  }

  .podcast-copy {
    min-width: 0;
    display: grid;
    gap: 2px;
  }

  .podcast-title {
    margin: 0;
    font-size: 1.02rem;
    color: var(--text-strong);
    line-height: 1.24;
    overflow-wrap: anywhere;
  }

  .podcast-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.78rem;
  }

  .podcast-play {
    width: 34px;
    height: 34px;
    border-radius: var(--radius-pill);
    border: 1px solid color-mix(in srgb, var(--ink) 35%, transparent);
    background: color-mix(in srgb, var(--ink) 46%, var(--surface));
    color: var(--surface);
    text-decoration: none;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .tracking-toggle-button {
    min-height: 30px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border-strong);
    background: var(--surface);
    color: var(--text-subtle-2);
    padding: 0 var(--space-2);
    font-size: 0.72rem;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
  }

  .tracking-toggle-button.is-marked {
    border-color: rgba(31, 143, 78, 0.44);
    background: var(--success-bg);
    color: var(--success-ink);
  }

  .podcast-end {
    margin: 0;
    border: 1px dashed var(--border-strong);
    border-radius: var(--radius-sub);
    background: var(--surface-soft);
    padding: var(--space-3);
    text-align: center;
    color: var(--text-subtle);
    font-size: 0.95rem;
  }

  .reading-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: var(--subject-space-tight);
  }

  .reading-card {
    border: 1px solid var(--border);
    border-radius: var(--radius-sub);
    background: var(--surface);
    padding: var(--space-3);
    display: grid;
    gap: var(--space-2);
  }

  .reading-card.is-active {
    border-color: color-mix(in srgb, var(--accent) 42%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--accent) 70%, transparent);
  }

  .reading-card.is-completed {
    border-color: color-mix(in srgb, var(--success) 38%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--success) 72%, transparent);
    background: var(--success-bg);
  }

  .reading-card.is-missing {
    border-color: color-mix(in srgb, var(--danger) 42%, transparent);
    box-shadow: inset 3px 0 0 color-mix(in srgb, var(--danger) 74%, transparent);
    background: var(--danger-bg-soft);
  }

  .reading-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .reading-title {
    margin: 0;
    color: var(--text-strong);
    font-size: 1.06rem;
    line-height: 1.22;
  }

  .reading-meta {
    margin: 0;
    color: var(--muted);
    font-size: 0.84rem;
  }

  .reading-actions {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    flex-wrap: wrap;
  }

  .reading-quiz-link {
    min-height: 30px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--text-subtle-2);
    background: var(--surface-soft);
  }

  .reading-difficulties {
    display: flex;
    align-items: stretch;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .difficulty-chip {
    min-height: 40px;
    border-radius: var(--radius-pill);
    border: 1px solid var(--border);
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    text-decoration: none;
    color: var(--text-strong);
    font-size: 0.9rem;
    background: var(--surface-soft);
  }

  .difficulty-chip.is-disabled {
    opacity: 0.5;
  }

  .difficulty-dot {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-pill);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid transparent;
    font-size: 0.82rem;
    font-weight: 700;
  }

  .difficulty-chip.is-easy {
    border-color: rgba(31, 143, 78, 0.35);
    background: var(--success-bg);
  }

  .difficulty-chip.is-easy .difficulty-dot {
    border-color: rgba(31, 143, 78, 0.4);
    background: var(--success-bg-strong);
    color: var(--success-ink);
  }

  .difficulty-chip.is-medium {
    border-color: rgba(164, 122, 33, 0.33);
    background: var(--warn-bg-soft);
  }

  .difficulty-chip.is-medium .difficulty-dot {
    border-color: rgba(164, 122, 33, 0.35);
    background: var(--warn-bg);
    color: var(--warn-ink-soft);
  }

  .difficulty-chip.is-hard {
    border-color: rgba(178, 59, 79, 0.35);
    background: var(--danger-bg-soft);
  }

  .difficulty-chip.is-hard .difficulty-dot {
    border-color: rgba(178, 59, 79, 0.35);
    background: var(--danger-bg);
    color: var(--danger-ink);
  }

  .missing-badge {
    min-height: 28px;
    border-radius: var(--radius-pill);
    border: 1px solid rgba(178, 59, 79, 0.5);
    background: var(--danger-bg-soft);
    color: var(--danger-ink);
    padding: 0 var(--space-2);
    display: inline-flex;
    align-items: center;
    font-size: 0.74rem;
    font-weight: 700;
  }

  .missing-note {
    margin: 0;
    color: var(--danger-ink);
    font-size: 0.82rem;
  }

  .section-empty,
  .empty-path {
    margin: 0;
    border: 1px dashed var(--border-strong);
    border-radius: var(--radius-sub);
    background: var(--surface-alt);
    padding: var(--space-3);
    color: var(--muted);
  }

  @media (min-width: 700px) {
    .subject-head {
      grid-template-columns: 1fr auto;
      align-items: start;
    }

    .subject-back {
      justify-self: end;
    }
  }

  @media (max-width: 720px) {
    .subject-path-layout {
      gap: var(--space-3);
      grid-template-columns: 42px minmax(0, 1fr);
    }

    .lecture-rail-link {
      width: 36px;
      height: 36px;
      font-size: 1.02rem;
    }

    .lecture-rail-item::after {
      top: 36px;
      left: 50%;
    }

    .active-lecture-card {
      padding: var(--space-3);
    }

    .active-lecture-card::before {
      left: -11px;
      top: 30px;
      width: 18px;
      height: 18px;
    }

    .podcast-row {
      grid-template-columns: minmax(0, 1fr) auto;
    }

    .podcast-row form {
      grid-column: 1 / -1;
      justify-self: start;
    }
  }
</style>

<div class="card subject-layout">
  <header class="subject-head">
    <div class="subject-head-copy">
      <h1 class="quiz-title">{{ subject.title }}</h1>
      <p class="muted">{{ subject.description }}</p>
    </div>
    <a class="ghost-link subject-back" href="{% url 'progress' %}">Tilbage til mit overblik</a>
  </header>

  <section class="subject-path" data-subject-path>
    {% if lecture_rail_items and active_lecture %}
    <div class="subject-path-layout">
      <aside class="lecture-rail" aria-label="Forelæsningsforløb">
        <ol class="lecture-rail-list">
          {% for rail in lecture_rail_items %}
          <li class="lecture-rail-item {% if rail.is_active %}is-active{% endif %} {% if rail.is_completed %}is-completed{% endif %}">
            <a
              class="lecture-rail-link"
              href="{{ rail.lecture_url }}"
              aria-current="{% if rail.is_active %}step{% else %}false{% endif %}"
              aria-label="{{ rail.lecture_display_title|default:rail.lecture_key }}"
            >
              {{ rail.index }}
            </a>
          </li>
          {% endfor %}
        </ol>
      </aside>

      <article class="active-lecture-card" data-active-lecture-key="{{ active_lecture.lecture_key }}">
        <header class="active-lecture-head">
          {% if active_lecture.lecture_display_label and active_lecture.lecture_display_name %}
          <h2 class="active-lecture-title">
            {{ active_lecture.lecture_display_label }}: {{ active_lecture.lecture_display_name }}
          </h2>
          {% else %}
          <h2 class="active-lecture-title">{{ active_lecture.lecture_display_title }}</h2>
          {% endif %}
          <p class="active-lecture-progress">{{ active_lecture.completed_quizzes }} / {{ active_lecture.total_quizzes }}</p>
          <p class="active-lecture-state">
            {% if active_lecture.status == 'completed' %}
            Fuldført
            {% elif active_lecture.progress_percent > 0 %}
            I gang
            {% else %}
            Ikke startet endnu
            {% endif %}
          </p>
        </header>

        <div class="active-lecture-sections">
          <section class="lecture-section lecture-quizzes">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M12 3a9 9 0 1 0 9 9h-1.6a7.4 7.4 0 1 1-7.4-7.4V3Zm0 4a5 5 0 1 0 5 5h-1.6a3.4 3.4 0 1 1-3.4-3.4V7Zm7.8-4.2-4.2 1.4 1.4 1.4-3.1 3.1 1.1 1.1 3.1-3.1 1.4 1.4 1.3-4.3Z"></path>
                  </svg>
                </span>
                <h3 class="section-title">Quizzer</h3>
              </div>
              <p class="section-note">quiz for alle kilder</p>
            </div>

            <div class="quiz-band">
              {% for slot in active_lecture.quiz_difficulty_slots %}
              <div class="quiz-slot is-{{ slot.difficulty }}">
                <p class="quiz-slot-label">{{ slot.label }}</p>
                {% if slot.quiz_url %}
                <a class="quiz-slot-chip" href="{{ slot.quiz_url }}">{{ slot.chip }}</a>
                {% else %}
                <span class="quiz-slot-chip is-disabled">{{ slot.chip }}</span>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </section>

          <section class="lecture-section lecture-podcasts">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon is-podcast" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M12 2a7 7 0 0 0-7 7v4a3 3 0 0 0 2 2.83V17a5 5 0 0 0 10 0v-1.17A3 3 0 0 0 19 13V9a7 7 0 0 0-7-7Zm0 2a5 5 0 0 1 5 5v4a1 1 0 0 1-1 1h-1V9a3 3 0 1 0-6 0v5H8a1 1 0 0 1-1-1V9a5 5 0 0 1 5-5Zm-1 5a1 1 0 1 1 2 0v8a3 3 0 1 1-6 0v-1h2v1a1 1 0 1 0 2 0V9Z"></path>
                  </svg>
                </span>
                <h3 class="section-title">Podcasts</h3>
              </div>
            </div>

            {% if active_lecture.podcast_rows %}
            <ul class="podcast-list">
              {% for podcast in active_lecture.podcast_rows %}
              <li class="podcast-row">
                <div class="podcast-copy">
                  <p class="podcast-title">Ep. {{ podcast.episode_index }}: {{ podcast.display_title }}</p>
                  <p class="podcast-meta">{{ podcast.source_label }}</p>
                </div>
                <a
                  class="podcast-play"
                  href="{{ podcast.url }}"
                  target="_blank"
                  rel="noopener"
                  aria-label="Afspil episode {{ podcast.episode_index }}"
                >
                  ▶
                </a>
                <form method="post" action="{{ podcast_tracking_url }}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                  <input type="hidden" name="lecture_key" value="{{ podcast.lecture_key }}" />
                  {% if podcast.reading_key %}
                  <input type="hidden" name="reading_key" value="{{ podcast.reading_key }}" />
                  {% endif %}
                  <input type="hidden" name="podcast_key" value="{{ podcast.podcast_key }}" />
                  <input type="hidden" name="action" value="{% if podcast.is_marked_listened %}unmark{% else %}mark{% endif %}" />
                  <button class="tracking-toggle-button {% if podcast.is_marked_listened %}is-marked{% endif %}" type="submit">
                    {% if podcast.is_marked_listened %}Lyttet{% else %}Markér lyttet{% endif %}
                  </button>
                </form>
              </li>
              {% endfor %}
            </ul>
            <p class="podcast-end">Ingen flere podcasts tilgængelige</p>
            {% else %}
            <p class="section-empty">Ingen podcasts registreret i denne forelæsning.</p>
            {% endif %}
          </section>

          <section class="lecture-section lecture-readings">
            <div class="lecture-section-head">
              <div class="section-title-wrap">
                <span class="asset-icon is-reading" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M4 5.5a2.5 2.5 0 0 1 2.5-2.5H20v16H6.5A2.5 2.5 0 0 0 4 21V5.5Zm2.5-1A1.5 1.5 0 0 0 5 6v12.2c.44-.23.94-.36 1.5-.36H19V4.5H6.5Z"></path>
                  </svg>
                </span>
                <h3 class="section-title">Readings</h3>
              </div>
            </div>

            {% if active_lecture.readings %}
            <ul class="reading-list">
              {% for reading in active_lecture.readings %}
              <li class="reading-card {% if reading.is_missing %}is-missing{% endif %} {% if reading.status == 'active' %}is-active{% elif reading.status == 'completed' %}is-completed{% endif %}">
                <div class="reading-top">
                  <div>
                    <p class="reading-title"><strong>{{ reading.reading_title }}</strong></p>
                    <p class="reading-meta">{{ reading.completed_quizzes }} / {{ reading.total_quizzes }}</p>
                    <p class="reading-meta">
                      {% if reading.status == 'completed' %}
                      Fuldført
                      {% elif reading.status == 'no_quiz' %}
                      Ingen quiz
                      {% elif reading.progress_percent > 0 %}
                      I gang
                      {% else %}
                      Ikke startet endnu
                      {% endif %}
                    </p>
                  </div>
                  <div class="reading-actions">
                    {% if reading.is_missing %}
                    <span class="missing-badge">Mangler kilde</span>
                    {% endif %}
                    {% if reading.primary_quiz_url %}
                    <a class="reading-quiz-link" href="{{ reading.primary_quiz_url }}">quiz</a>
                    {% endif %}
                    <form method="post" action="{{ reading_tracking_url }}">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                      <input type="hidden" name="lecture_key" value="{{ active_lecture.lecture_key }}" />
                      <input type="hidden" name="reading_key" value="{{ reading.reading_key }}" />
                      <input type="hidden" name="action" value="{% if reading.is_marked_read %}unmark{% else %}mark{% endif %}" />
                      <button class="tracking-toggle-button {% if reading.is_marked_read %}is-marked{% endif %}" type="submit">
                        {% if reading.is_marked_read %}Læst{% else %}Markér læst{% endif %}
                      </button>
                    </form>
                  </div>
                </div>

                {% if reading.is_missing %}
                <p class="missing-note">Denne reading er markeret som manglende i kildelisten.</p>
                {% endif %}

                <div class="reading-difficulties">
                  {% for slot in reading.difficulty_summary %}
                    {% if slot.quiz_url %}
                    <a class="difficulty-chip is-{{ slot.difficulty }}" href="{{ slot.quiz_url }}">
                      <span class="difficulty-dot">{{ slot.chip }}</span>
                      <span>{{ slot.label }}</span>
                    </a>
                    {% else %}
                    <span class="difficulty-chip is-{{ slot.difficulty }} is-disabled">
                      <span class="difficulty-dot">{{ slot.chip }}</span>
                      <span>{{ slot.label }}</span>
                    </span>
                    {% endif %}
                  {% endfor %}
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="section-empty">Ingen readings registreret i denne forelæsning.</p>
            {% endif %}
          </section>
        </div>
      </article>
    </div>
    {% else %}
    <p class="empty-path">Ingen læringssti endnu for dette fag.</p>
    {% endif %}
  </section>

  {% if readings_error %}
  <div class="message error">{{ readings_error }}</div>
  {% endif %}
</div>
{% endblock %}
